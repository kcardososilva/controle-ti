{% extends 'base.html' %}
{% block title %}Detalhe do Centro de Custo{% endblock %}
{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"/>

<style>
:root{--line:#e5e7eb;--ink:#172133;--card:#fff;--soft:#f8fafc;--shadow:0 20px 40px rgba(2,6,23,.07);--h:48px;--rad:12px;--padL:44px}
*{box-sizing:border-box}
.wrap{max-width:1100px;margin:22px auto;background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);padding:22px}

/* header */
.header{display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap}
.header h2{margin:0;display:flex;align-items:center;gap:10px;color:var(--ink)}
.actions{display:flex;gap:10px;flex-wrap:wrap}
.btn{border:none;border-radius:10px;padding:10px 16px;font-weight:800;cursor:pointer;display:inline-flex;align-items:center;gap:8px;text-decoration:none}
.btn-secondary{background:#f3f4f6;color:#172133;border:1px solid #d8dee9}
.btn-primary{background:linear-gradient(90deg,#223259,#172133);color:#fff}
.btn-add{background:linear-gradient(90deg,#10b981,#059669);color:#fff}

/* cards */
.grid{margin-top:16px;display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px}
.card{background:var(--soft);border:1px solid var(--line);border-radius:12px;padding:14px}
.label{font-weight:800;color:#334155;margin-bottom:6px}
.value{color:#0f172a}
.meta{margin-top:6px;color:#475569;font-size:.95rem}
.badge-pmb{display:inline-block;padding:3px 10px;border-radius:999px;font-weight:800;font-size:.95rem}
.badge-pmb.sim{background:#e8fff3;color:#15803d}
.badge-pmb.nao{background:#fee2e2;color:#b91c1c}

/* bloco itens */
.block{margin-top:18px;background:var(--card);border:1px solid var(--line);border-radius:14px}
.block-h{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-bottom:1px solid var(--line)}
.block-h h3{margin:0;display:flex;align-items:center;gap:10px;color:#0f172a;font-size:1.05rem}
.block-c{padding:14px}

/* filtros (sem sobreposição) */
.filtros{display:grid;grid-template-columns:minmax(260px,1fr) auto;gap:12px;align-items:end;margin-bottom:12px}
@media (max-width:700px){.filtros{grid-template-columns:1fr}}
.group{display:flex;flex-direction:column}
.group label{font-weight:800;margin-bottom:6px}
.filtro-icon-input{position:relative}
.filtro-icon-input .ico{position:absolute;left:12px;top:50%;transform:translateY(-50%);color:#334155}
.ctrl{width:100%;height:var(--h);padding:8px 14px 8px var(--padL);border:1px solid #d5deea;border-radius:var(--rad);background:#fff;color:#111827;font-size:1rem;outline:none;transition:border .15s,box-shadow .15s}
.ctrl:focus{border-color:#93c5fd;box-shadow:0 0 0 3px #93c5fd55}

/* tabela */
.table-wrap{width:100%;overflow:auto;border:1px solid var(--line);border-radius:12px}
table{width:100%;border-collapse:collapse;min-width:920px;background:#fff}
thead th{position:sticky;top:0;background:#0b1220;color:#fff;border-bottom:1px solid #0f172a;padding:11px 12px;text-align:left;font-weight:900}
tbody td{padding:11px 12px;border-bottom:1px solid #eef2f7;color:#0f172a}
tbody tr:nth-child(odd){background:#fbfdff}
tbody tr:hover{background:#f3f7ff}
.status-chip{display:inline-block;padding:2px 10px;border-radius:999px;font-weight:800;font-size:.85rem}
.status-chip.ativo{background:#e8fff3;color:#15803d}
.status-chip.backup{background:#eef2ff;color:#1e40af}
.status-chip.manutencao{background:#fff7ed;color:#9a3412}
.status-chip.defeito{background:#fee2e2;color:#b91c1c}
.icon-btn{background:#fff;border:1.3px solid #dbe3ef;color:#1f2937;border-radius:50%;padding:7px 8px;margin:0 2px;font-size:1.05rem;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;text-decoration:none}
.icon-btn:hover{background:#f8fbff;border-color:#bcd6ff}
.icon-btn.primary{background:#172133;color:#fff;border-color:#172133}
.icon-btn.primary:hover{filter:brightness(.95)}
</style>

<div class="wrap">
  <!-- Header -->
    <h2 style="color: #0b1220;"><i class="fa fa-coins"></i> Detalhe do Centro de Custo</h2>
    <div class="actions">
      <a href="{% url 'centrocusto_list' %}" class="btn btn-secondary"><i class="fa fa-arrow-left"></i> Voltar</a>
      <a href="{% url 'centrocusto_update' obj.pk %}" class="btn btn-primary"><i class="fa fa-pen"></i> Editar</a>
    </div>

  <!-- Dados do centro de custo -->
  <div class="grid">
    <div class="card"><div class="label">Número</div><div class="value">{{ obj.numero }}</div></div>
    <div class="card"><div class="label">Departamento</div><div class="value">{{ obj.departamento }}</div></div>
    <div class="card">
      <div class="label">PMB?</div>
      <div class="value"><span class="badge-pmb {{ obj.pmb }}">{{ obj.get_pmb_display }}</span></div>
    </div>
    <div class="card" style="grid-column:1/-1">
      <div class="label">Auditoria</div>
      <div class="meta">Criado por: {{ obj.criado_por|default:"-" }} em {{ obj.created_at|date:"d/m/Y H:i" }}</div>
      <div class="meta">Atualizado por: {{ obj.atualizado_por|default:"-" }} em {{ obj.updated_at|date:"d/m/Y H:i" }}</div>
    </div>
  </div>

  <!-- Itens vinculados ao centro de custo -->
  <div class="block">
    <div class="block-h">
      <h3><i class="fa fa-laptop"></i> Itens vinculados a {{ obj.numero }} — {{ obj.departamento }}</h3>
      <div class="actions">
        <span class="meta">{{ itens_cc|length }} item{{ itens_cc|length|pluralize }}</span>
        <a href="{% url 'cadastrar_equipamento' %}" class="btn btn-add"><i class="fa fa-plus"></i> Adicionar Item</a>
      </div>
    </div>

    <div class="block-c">
      <!-- Filtros locais (client-side) -->
      <div class="filtros" id="flt">
        <div class="group">
          <label style="color: #0b1220;">Buscar</label>
          <div class="filtro-icon-input">
            <span class="ico"><i class="fa fa-search"></i></span>
            <input id="q" type="text" class="ctrl" placeholder="Nome, nº de série, subtipo...">
          </div>
        </div>
        <div style="display:flex;gap:10px;justify-content:flex-end">
          <button class="btn btn-secondary" type="button" id="btnClear"><i class="fa fa-eraser"></i> Limpar</button>
        </div>
      </div>

      <div class="table-wrap">
        <table id="tbl">
          <thead>
            <tr>
              <th style="width:56px">#</th>
              <th>Item</th>
              <th>Nº Série</th>
              <th>Subtipo</th>
              <th>Localidade</th>
              <th>Quantidade</th>
              <th>Status</th>
              <th style="width:140px">Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for it in itens_cc %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td>{{ it.nome }}</td>
              <td>{{ it.numero_serie|default:"-" }}</td>
              <td>{% if it.subtipo %}{{ it.subtipo.nome }}{% else %}-{% endif %}</td>
              <td>{% if it.localidade %}{{ it.localidade.local }}{% else %}-{% endif %}</td>
              <td>{{ it.quantidade|default:"0" }}</td>
              <td><span class="status-chip {{ it.status }}">{{ it.get_status_display|default:it.status|capfirst }}</span></td>
              <td style="white-space:nowrap">
                <a class="icon-btn" title="Detalhar" href="{% url 'equipamento_detalhe' it.id %}"><i class="fa fa-eye"></i></a>
                {% if it.precisa_preventiva == 'sim' %}
                  <a class="icon-btn primary" title="Iniciar preventiva" href="{% url 'preventiva_start_item' it.id %}">
                    <i class="fa fa-shield-heart"></i>
                  </a>
                {% endif %}
              </td>
            </tr>
            {% empty %}
            <tr><td colspan="8" style="text-align:center;color:#64748b;padding:14px">Nenhum item vinculado a este centro de custo.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
// Filtro client-side sem sobreposição
(function(){
  const q = document.getElementById('q');
  const tbl = document.getElementById('tbl');
  const rows = () => Array.from(tbl.querySelectorAll('tbody tr'));
  const norm = s => (s||'').toString().toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  let t;
  function apply(){
    const term = norm(q.value);
    rows().forEach(r=>{
      const text = norm(r.innerText);
      r.style.display = text.includes(term) ? '' : 'none';
    });
  }
  q.addEventListener('input', ()=>{ clearTimeout(t); t=setTimeout(apply, 200); });
  document.getElementById('btnClear').addEventListener('click', ()=>{
    q.value=''; apply(); q.focus();
  });
})();
</script>
{% endblock %}
