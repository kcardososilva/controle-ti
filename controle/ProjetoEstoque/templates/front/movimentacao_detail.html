{% extends "base.html" %}
{% load static %}

{% block title %}Detalhes da Movimentação{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

<style>
:root{
  --ink:#0f172a; --muted:#475569; --line:#e5e7eb; --soft:#f8fafc; --card:#ffffff;
  --shadow:0 8px 20px rgba(2,6,23,.05);
  --rad:12px;
}
*{box-sizing:border-box}
a{text-decoration:none}
.page{max-width:1080px;margin:16px auto;padding:0 14px;color:var(--ink);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial}

/* Cabeçalho existente */
.breadcrumb{display:flex;gap:8px;align-items:center;flex-wrap:wrap;color:var(--muted);font-weight:600;margin-bottom:8px}
.breadcrumb a{color:var(--muted)}
.head{display:flex;align-items:center;gap:12px;margin:6px 0 10px;flex-wrap:wrap}
.head h1{margin:0;font-size:1.45rem;display:flex;align-items:center;gap:10px}
.chips{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
.chip{
  padding:4px 10px;border-radius:999px;border:1px solid var(--line);background:#fff;
  font-weight:700;font-size:.82rem;display:inline-flex;gap:8px;align-items:center;color:#111827
}

/* Barra resumo – neutra */
.summary{
  position:sticky;top:72px;
  background:#fff;border:1px solid var(--line);border-radius:10px;box-shadow:var(--shadow);
  display:grid;grid-template-columns:1.1fr .9fr .6fr auto;gap:10px;align-items:center;
  padding:10px 12px;margin-bottom:12px;z-index:2}
@media (max-width:900px){ .summary{grid-template-columns:1fr 1fr} }
.summary .kv{display:flex;gap:10px;align-items:center;min-width:0}
.summary .kv i{color:#64748b}
.summary .kv-label{color:#6b7280;font-weight:700;font-size:.84rem}
.summary .kv-value{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.summary .actions{display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap}
.btn{border:1px solid var(--line);border-radius:8px;padding:8px 12px;background:#fff;cursor:pointer;font-weight:700}
.btn:hover{background:var(--soft)}

/* Painel e seções – look corporativo enxuto */
.panel{background:var(--card);border:1px solid var(--line);border-radius:var(--rad)}
.section{padding:16px 16px 12px}
.section h3{margin:0 0 12px;display:flex;align-items:center;gap:8px;font-size:1.02rem;font-weight:800}
.grid{display:grid;gap:10px}
.g-3{grid-template-columns:repeat(3,minmax(240px,1fr))}
.g-2{grid-template-columns:repeat(2,minmax(280px,1fr))}
@media (max-width:900px){.g-3,.g-2{grid-template-columns:1fr}}

/* “Cards” viram blocos discretos */
.tile{background:#fff;border:1px solid var(--line);border-radius:10px;padding:10px}
.tile strong{display:block;color:#111827;margin-bottom:6px;font-size:.92rem}
.tile span{color:#111827;word-break:break-word}
.muted{color:#6b7280}

/* PDF */
.pdf-wrap{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
.pdf-frame{width:100%;height:460px;border:1px solid var(--line);border-radius:10px;background:#fff}

/* Auditoria */
.audit{display:grid;gap:10px;grid-template-columns:repeat(2,minmax(240px,1fr))}
@media (max-width:900px){.audit{grid-template-columns:1fr}}

/* Rodapé */
.footer-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
.badge-info{display:inline-flex;gap:8px;align-items:center;padding:4px 8px;border-radius:999px;border:1px solid var(--line);font-weight:800}
</style>

<div class="page">
  <!-- Breadcrumb -->
  <nav class="breadcrumb" aria-label="Navegação">
    <a href="{% url 'movimentacao_list' %}"><i class="fa fa-arrow-left"></i> Movimentações</a>
    <span>/</span><span>Detalhe</span>
    {% if movimentacao and movimentacao.pk %}
      <span class="badge-info"><i class="fa fa-hashtag"></i>&nbsp;{{ movimentacao.pk }}</span>
    {% endif %}
  </nav>

  <!-- Header -->
  <div class="head">
    <h1><i class="fa fa-clipboard-list"></i> Detalhes da Movimentação</h1>
    <div class="chips">
      {% if movimentacao and movimentacao.tipo_movimentacao %}
        <span class="chip">
          <i class="fa fa-shuffle"></i>
          {{ movimentacao.get_tipo_movimentacao_display|default:movimentacao.tipo_movimentacao|capfirst }}
        </span>
      {% endif %}
      {% if movimentacao and movimentacao.tipo_transferencia %}
        <span class="chip">
          <i class="fa fa-person-arrow-right"></i>
          {{ movimentacao.get_tipo_transferencia_display|default:movimentacao.tipo_transferencia|capfirst }}
        </span>
      {% endif %}
      {% if movimentacao and movimentacao.chamado %}
        <span class="chip"><i class="fa fa-ticket"></i> Chamado: {{ movimentacao.chamado }}</span>
      {% endif %}
    </div>
  </div>

  <!-- Summary sticky -->
  <div class="summary">
    <div class="kv">
      <i class="fa fa-box"></i>
      <div>
        <div class="kv-label">Item</div>
        <div class="kv-value">
          {% if movimentacao and movimentacao.item %}
            {{ movimentacao.item.nome|default:"-" }}
            {% if movimentacao.item.numero_serie %}
              <span class="muted"> · {{ movimentacao.item.numero_serie }}</span>
            {% endif %}
          {% else %}-{% endif %}
        </div>
      </div>
    </div>
    <div class="kv">
      <i class="fa fa-user"></i>
      <div>
        <div class="kv-label">Usuário</div>
        <div class="kv-value">
          {% if movimentacao and movimentacao.usuario %}
            {{ movimentacao.usuario.nome|default:"—" }}
          {% else %}—{% endif %}
        </div>
      </div>
    </div>
    <div class="kv">
      <i class="fa fa-calendar-days"></i>
      <div>
        <div class="kv-label">Registrada</div>
        <div class="kv-value">
          {% if movimentacao and movimentacao.created_at %}
            {{ movimentacao.created_at|date:"d/m/Y H:i" }}
          {% else %}—{% endif %}
        </div>
      </div>
    </div>
    <div class="actions">
      <button class="btn" type="button" id="btnCopy"><i class="fa fa-link"></i>&nbsp;Copiar link</button>
    </div>
  </div>

  <div class="panel">
    <!-- Principais -->
    <div class="section">
      <h3><i class="fa fa-circle-info"></i> Informações principais</h3>
      <div class="grid g-3">
        <div class="tile">
          <strong>Item</strong>
          <span>
            {% if movimentacao and movimentacao.item %}
              {{ movimentacao.item.nome|default:"-" }}
              {% if movimentacao.item.numero_serie %}
                <span class="muted"> — Nº Série: {{ movimentacao.item.numero_serie }}</span>
              {% endif %}
            {% else %}-{% endif %}
          </span>
        </div>
        <div class="tile">
          <strong>Usuário</strong>
          <span>
            {% if movimentacao and movimentacao.usuario %}
              {{ movimentacao.usuario.nome|default:"—" }}
            {% else %}—{% endif %}
          </span>
        </div>
        <div class="tile">
          <strong>Quantidade</strong>
          <span>
            {% if movimentacao and movimentacao.quantidade %}
              {{ movimentacao.quantidade }}
            {% else %}1{% endif %}
          </span>
        </div>
      </div>
    </div>

    <!-- Origem/Destino (SEM fallback para item.*) -->
    <div class="section">
      <h3><i class="fa fa-route"></i> Origem e destino</h3>
      <div class="grid g-3">
        <div class="tile">
          <strong>Localidade Origem</strong>
          <span>{{ origem_localidade|default:"—" }}</span>
        </div>
        <div class="tile">
          <strong>Centro de Custo Origem</strong>
          <span>
            {% if origem_cc_num or origem_cc_dep %}
              {{ origem_cc_num|default:"" }}{% if origem_cc_num and origem_cc_dep %} — {% endif %}{{ origem_cc_dep|default:"" }}
            {% else %}—{% endif %}
          </span>
        </div>
        <div class="tile">
          <strong>Localidade Destino</strong>
          <span>{{ dest_localidade|default:"—" }}</span>
        </div>
        <div class="tile">
          <strong>Centro de Custo Destino</strong>
          <span>
            {% if dest_cc_num or dest_cc_dep %}
              {{ dest_cc_num|default:"" }}{% if dest_cc_num and dest_cc_dep %} — {% endif %}{{ dest_cc_dep|default:"" }}
            {% else %}—{% endif %}
          </span>
        </div>
        <div class="tile">
          <strong>Status do Item (após)</strong>
          <span>{{ status_pos|default:"—" }}</span>
        </div>
        <div class="tile">
          <strong>Efeito no Estoque</strong>
          <span class="muted">{{ efeito_estoque }}</span>
        </div>
      </div>
    </div>

    <!-- Financeiro / Observações -->
    <div class="section">
      <h3><i class="fa fa-file-pen"></i> Financeiro e observações</h3>
      <div class="grid g-2">
        <div class="tile">
          <strong>Chamado</strong>
          <span>{% if movimentacao and movimentacao.chamado %}{{ movimentacao.chamado }}{% else %}—{% endif %}</span>
        </div>
        <div class="tile">
          <strong>Custo</strong>
          <span>
            {% if movimentacao and movimentacao.custo %}
              R$ {{ movimentacao.custo|floatformat:2 }}
            {% else %}—{% endif %}
          </span>
        </div>
        <div class="tile" style="grid-column:1/-1">
          <strong>Observações</strong>
          <span>{% if movimentacao and movimentacao.observacao %}{{ movimentacao.observacao }}{% else %}Sem observações{% endif %}</span>
        </div>
      </div>
    </div>

    <!-- Documento -->
    {% if movimentacao and movimentacao.termo_pdf %}
    <div class="section">
      <h3><i class="fa fa-file-pdf"></i> Termo (PDF)</h3>
      <div class="pdf-wrap">
        <a href="{{ movimentacao.termo_pdf.url }}" target="_blank" class="btn">
          <i class="fa fa-up-right-from-square"></i>&nbsp;Abrir em nova aba
        </a>
        <a href="{{ movimentacao.termo_pdf.url }}" download class="btn">
          <i class="fa fa-download"></i>&nbsp;Baixar PDF
        </a>
      </div>
      <object data="{{ movimentacao.termo_pdf.url }}#view=FitH" type="application/pdf" class="pdf-frame">
        <embed src="{{ movimentacao.termo_pdf.url }}" type="application/pdf" class="pdf-frame"/>
        <p class="muted" style="padding:8px">
          Seu navegador não consegue exibir PDF embutido.
          <a href="{{ movimentacao.termo_pdf.url }}" target="_blank">Clique aqui para abrir</a>.
        </p>
      </object>
    </div>
    {% endif %}

    <!-- Auditoria -->
    <div class="section">
      <h3><i class="fa fa-user-shield"></i> Auditoria</h3>
      <div class="audit">
        <div class="tile">
          <strong>Criado por</strong>
          <span>
            {% if movimentacao and movimentacao.criado_por %}{{ movimentacao.criado_por.username|default:"—" }}{% else %}—{% endif %}
            · {% if movimentacao and movimentacao.created_at %}{{ movimentacao.created_at|date:"d/m/Y H:i" }}{% else %}—{% endif %}
          </span>
        </div>
        <div class="tile">
          <strong>Atualizado por</strong>
          <span>
            {% if movimentacao and movimentacao.atualizado_por %}{{ movimentacao.atualizado_por.username|default:"—" }}{% else %}—{% endif %}
            · {% if movimentacao and movimentacao.updated_at %}{{ movimentacao.updated_at|date:"d/m/Y H:i" }}{% else %}—{% endif %}
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- Rodapé -->
  <div class="footer-actions">
    <a href="{% url 'movimentacao_list' %}" class="btn"><i class="fa fa-arrow-left"></i>&nbsp;Voltar</a>
  </div>
</div>

<script>
  // Copiar link da página
  document.getElementById('btnCopy')?.addEventListener('click', async () => {
    try{
      await navigator.clipboard.writeText(location.href);
      const el = document.getElementById('btnCopy');
      const old = el.innerHTML;
      el.innerHTML = '<i class="fa fa-check"></i>&nbsp;Copiado!';
      setTimeout(()=> el.innerHTML = old, 1600);
    }catch(e){ alert('Não foi possível copiar o link.'); }
  });
</script>
{% endblock %}
