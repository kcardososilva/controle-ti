{% extends "base.html" %}
{% load static %}

{% block title %}Detalhes da Movimentação{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

<style>
:root{
  /* Paleta neutra profissional com acentos frios */
  --ink:#0f172a; --muted:#475569; --line:#e5e7eb; --soft:#f8fafc; --card:#ffffff;
  --accent:#1e3a8a; --accent-2:#2563eb; --info:#0ea5e9;
  --ok:#16a34a; --ok-soft:#e8fff3;
  --warn:#b45309; --warn-soft:#fff7ed;
  --bad:#b91c1c; --bad-soft:#fee2e2;

  --shadow:0 18px 40px rgba(2,6,23,.07);
  --rad:14px;
}
*{box-sizing:border-box}
a{text-decoration:none}
.page{
  max-width:1100px;margin:16px auto;padding:0 14px;color:var(--ink);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial
}

/* ===== BREADCRUMB + HEADER ===== */
.breadcrumb{display:flex;gap:8px;align-items:center;flex-wrap:wrap;color:var(--muted);font-weight:700;margin-bottom:8px}
.breadcrumb a{color:var(--muted)}
.breadcrumb a:hover{color:var(--accent-2)}
.head{display:flex;align-items:center;gap:12px;margin:6px 0 10px;flex-wrap:wrap}
.head h1{margin:0;font-size:1.6rem;display:flex;align-items:center;gap:10px}
.chips{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
.chip{
  padding:6px 10px;border-radius:999px;border:1px solid #e2e8f0;background:#fff;
  font-weight:900;font-size:.86rem;display:inline-flex;gap:8px;align-items:center;color:#0f172a
}
/* tipo cor */
.chip.transferencia{background:#eef2ff;border-color:#c7d2fe;color:#1e40af}
.chip.baixa{background:var(--bad-soft);border-color:#fecaca;color:#7f1d1d}
.chip.envio_manutencao{background:#fff7ed;border-color:#fed7aa;color:#7c2d12}
.chip.retorno,.chip.retorno_manutencao{background:#dcfce7;border-color:#bbf7d0;color:#166534}

/* ===== STICKY SUMMARY BAR ===== */
.summary{
  position:sticky;top:calc(72px + 6px);
  background:linear-gradient(180deg,#f8fbff,#ffffff);
  border:1px solid var(--line);border-radius:12px;box-shadow:var(--shadow);
  display:grid;grid-template-columns:1.1fr .9fr .6fr auto;gap:10px;align-items:center;
  padding:10px 12px;margin-bottom:12px;z-index:2
}
@media (max-width:900px){ .summary{grid-template-columns:1fr 1fr} }
.summary .kv{display:flex;gap:8px;align-items:center;min-width:0}
.summary .kv i{color:var(--info)}
.summary .kv-label{color:var(--muted);font-weight:800}
.summary .kv-value{font-weight:900;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.summary .actions{display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap}
.btn{
  border:none;border-radius:10px;padding:8px 12px;font-weight:900;cursor:pointer;
  display:inline-flex;align-items:center;gap:8px
}
.btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff}
.btn.light{background:#fff;border:1.3px solid #dbe6f1;color:#334155}
.btn:hover{filter:brightness(.98)}

/* ===== PAINEL ===== */
.panel{background:var(--card);border:1px solid var(--line);border-radius:var(--rad);box-shadow:var(--shadow)}
.section{padding:16px 16px 10px}
.section h3{margin:0 0 12px;display:flex;align-items:center;gap:10px;font-size:1.08rem}
.grid{display:grid;gap:12px}
.g-3{grid-template-columns:repeat(3,minmax(240px,1fr))}
.g-2{grid-template-columns:repeat(2,minmax(280px,1fr))}
@media (max-width:900px){.g-3,.g-2{grid-template-columns:1fr}}

.tile{background:#f9fafc;border:1px solid var(--line);border-radius:12px;padding:12px}
.tile strong{display:block;color:#1f2937;margin-bottom:6px}
.tile span{color:var(--ink);word-break:break-word}
.muted{color:var(--muted)}

/* ===== VIEWER PDF ===== */
.pdf-wrap{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:10px}
.pdf-frame{width:100%;height:460px;border:1px solid var(--line);border-radius:12px;background:#fff}

/* ===== AUDITORIA ===== */
.audit{display:grid;gap:12px;grid-template-columns:repeat(2,minmax(240px,1fr))}
@media (max-width:900px){.audit{grid-template-columns:1fr}}

/* ===== ACTIONS FOOTER ===== */
.footer-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
.badge-info{display:inline-flex;gap:8px;align-items:center;padding:6px 10px;border-radius:999px;background:#eef2ff;border:1px solid #c7d2fe;color:#1e40af;font-weight:900}

/* realce por tipo na borda do painel */
.panel.transferencia{box-shadow:0 0 0 3px #e0e7ff inset, var(--shadow)}
.panel.baixa{box-shadow:0 0 0 3px #fee2e2 inset, var(--shadow)}
.panel.envio_manutencao{box-shadow:0 0 0 3px #ffedd5 inset, var(--shadow)}
.panel.retorno,.panel.retorno_manutencao{box-shadow:0 0 0 3px #dcfce7 inset, var(--shadow)}
</style>

<div class="page">
  <!-- Breadcrumb -->
  <nav class="breadcrumb" aria-label="Navegação">
    <a href="{% url 'movimentacao_list' %}"><i class="fa fa-arrow-left"></i> Movimentações</a>
    <span>/</span>
    <span>Detalhe</span>
    {% if movimentacao and movimentacao.pk %}
      <span class="badge-info"><i class="fa fa-hashtag"></i> {{ movimentacao.pk }}</span>
    {% endif %}
  </nav>

  <!-- Header -->
  <div class="head">
    <h1><i class="fa fa-clipboard-list"></i> Detalhes da Movimentação</h1>
    <div class="chips">
      {% if movimentacao and movimentacao.tipo_movimentacao %}
        <span class="chip {{ movimentacao.tipo_movimentacao }}">
          <i class="fa fa-shuffle"></i>
          {{ movimentacao.get_tipo_movimentacao_display|default:movimentacao.tipo_movimentacao|capfirst }}
        </span>
      {% endif %}
      {% if movimentacao and movimentacao.tipo_transferencia %}
        <span class="chip">
          <i class="fa fa-person-arrow-right"></i>
          {{ movimentacao.get_tipo_transferencia_display|default:movimentacao.tipo_transferencia|capfirst }}
        </span>
      {% endif %}
      {% if movimentacao and movimentacao.chamado %}
        <span class="chip"><i class="fa fa-ticket"></i> Chamado: {{ movimentacao.chamado }}</span>
      {% endif %}
    </div>
  </div>

  <!-- Summary sticky -->
  <div class="summary">
    <div class="kv">
      <i class="fa fa-box"></i>
      <div>
        <div class="kv-label">Item</div>
        <div class="kv-value">
          {% if movimentacao and movimentacao.item %}
            {{ movimentacao.item.nome|default:"-" }}
            {% if movimentacao.item.numero_serie %}
              <span class="muted"> · {{ movimentacao.item.numero_serie }}</span>
            {% endif %}
          {% else %}-{% endif %}
        </div>
      </div>
    </div>
    <div class="kv">
      <i class="fa fa-user"></i>
      <div>
        <div class="kv-label">Usuário</div>
        <div class="kv-value">
          {% if movimentacao and movimentacao.usuario %}
            {{ movimentacao.usuario.nome|default:"—" }}
          {% else %}—{% endif %}
        </div>
      </div>
    </div>
    <div class="kv">
      <i class="fa fa-calendar-days"></i>
      <div>
        <div class="kv-label">Registrada</div>
        <div class="kv-value">
          {% if movimentacao and movimentacao.created_at %}
            {{ movimentacao.created_at|date:"d/m/Y H:i" }}
          {% else %}—{% endif %}
        </div>
      </div>
    </div>
    <div class="actions">
      <button class="btn light" type="button" id="btnCopy"><i class="fa fa-link"></i> Copiar link</button>
      
    </div>
  </div>

  <!-- Painel principal -->
  <div class="panel {% if movimentacao and movimentacao.tipo_movimentacao %}{{ movimentacao.tipo_movimentacao }}{% endif %}">
    <!-- Bloco 1: principais -->
    <div class="section">
      <h3><i class="fa fa-circle-info" style="color:var(--info)"></i> Informações principais</h3>
      <div class="grid g-3">
        <div class="tile">
          <strong>Item</strong>
          <span>
            {% if movimentacao and movimentacao.item %}
              {{ movimentacao.item.nome|default:"-" }}
              {% if movimentacao.item.numero_serie %}
                <span class="muted"> — Nº Série: {{ movimentacao.item.numero_serie }}</span>
              {% endif %}
            {% else %}-{% endif %}
          </span>
        </div>
        <div class="tile">
          <strong>Usuário</strong>
          <span>
            {% if movimentacao and movimentacao.usuario %}
              {{ movimentacao.usuario.nome|default:"—" }}
            {% else %}—{% endif %}
          </span>
        </div>
        <div class="tile">
          <strong>Quantidade</strong>
          <span>
            {% if movimentacao and movimentacao.quantidade %}
              {{ movimentacao.quantidade }}
            {% else %}1{% endif %}
          </span>
        </div>
      </div>
    </div>

    <!-- Bloco 2: Origem/Destino -->
    <div class="section">
      <h3><i class="fa fa-route" style="color:var(--accent-2)"></i> Origem e destino</h3>
      <div class="grid g-3">
        <div class="tile">
          <strong>Localidade Origem</strong>
          <span>
            {% if movimentacao and movimentacao.localidade_origem %}
              {{ movimentacao.localidade_origem.local }}
            {% elif movimentacao and movimentacao.item and movimentacao.item.localidade %}
              {{ movimentacao.item.localidade.local }}
            {% else %}-{% endif %}
          </span>
        </div>
        <div class="tile">
          <strong>Centro de Custo Origem</strong>
          <span>
            {% if movimentacao and movimentacao.centro_custo_origem %}
              {{ movimentacao.centro_custo_origem.numero }} — {{ movimentacao.centro_custo_origem.departamento }}
            {% elif movimentacao and movimentacao.item and movimentacao.item.centro_custo %}
              {{ movimentacao.item.centro_custo.numero }} — {{ movimentacao.item.centro_custo.departamento }}
            {% else %}-{% endif %}
          </span>
        </div>
        <div class="tile">
          <strong>Localidade Destino</strong>
          <span>
            {% if movimentacao and movimentacao.localidade_destino %}
              {{ movimentacao.localidade_destino.local }}
            {% else %}-{% endif %}
          </span>
        </div>
        <div class="tile">
          <strong>Centro de Custo Destino</strong>
          <span>
            {% if movimentacao and movimentacao.centro_custo_destino %}
              {{ movimentacao.centro_custo_destino.numero }} — {{ movimentacao.centro_custo_destino.departamento }}
            {% else %}-{% endif %}
          </span>
        </div>
        <div class="tile">
          <strong>Status do Item (após)</strong>
          <span>
            {% if movimentacao and movimentacao.tipo_movimentacao %}
              {% if movimentacao.tipo_movimentacao == 'retorno' or movimentacao.tipo_movimentacao == 'retorno_manutencao' %}
                Backup
              {% elif movimentacao.item %}
                {{ movimentacao.item.get_status_display|default:movimentacao.item.status|capfirst }}
              {% else %}
                —
              {% endif %}
            {% else %}—{% endif %}
          </span>
        </div>
        <div class="tile">
          <strong>Efeito no Estoque</strong>
          <span class="muted">
            {% if movimentacao and movimentacao.tipo_movimentacao %}
              {% if movimentacao.tipo_movimentacao == 'entrada' %}
                Entrada (+{{ movimentacao.quantidade|default:'1' }})
              {% elif movimentacao.tipo_movimentacao == 'baixa' or movimentacao.tipo_movimentacao == 'envio_manutencao' %}
                Saída (−{{ movimentacao.quantidade|default:'1' }})
              {% elif movimentacao.tipo_movimentacao == 'transferencia' or movimentacao.tipo_movimentacao == 'retorno' or movimentacao.tipo_movimentacao == 'retorno_manutencao' %}
                Sem alteração de quantidade (transferência/retorno)
              {% else %} — {% endif %}
            {% else %} — {% endif %}
          </span>
        </div>
      </div>
    </div>

    <!-- Bloco 3: Financeiro / Observações -->
    <div class="section">
      <h3><i class="fa fa-file-pen" style="color:var(--info)"></i> Financeiro e observações</h3>
      <div class="grid g-2">
        <div class="tile">
          <strong>Chamado</strong>
          <span>{% if movimentacao and movimentacao.chamado %}{{ movimentacao.chamado }}{% else %}—{% endif %}</span>
        </div>
        <div class="tile">
          <strong>Custo</strong>
          <span>
            {% if movimentacao and movimentacao.custo %}
              R$ {{ movimentacao.custo|floatformat:2 }}
            {% else %}—{% endif %}
          </span>
        </div>
        <div class="tile" style="grid-column:1/-1">
          <strong>Observações</strong>
          <span>{% if movimentacao and movimentacao.observacao %}{{ movimentacao.observacao }}{% else %}Sem observações{% endif %}</span>
        </div>
      </div>
    </div>

    <!-- Bloco 4: Documento -->
    {% if movimentacao and movimentacao.termo_pdf %}
    <div class="section">
      <h3><i class="fa fa-file-pdf" style="color:#dc2626"></i> Termo (PDF)</h3>
      <div class="pdf-wrap">
        <a href="{{ movimentacao.termo_pdf.url }}" target="_blank" class="btn light">
          <i class="fa fa-up-right-from-square"></i> Abrir em nova aba
        </a>
        <a href="{{ movimentacao.termo_pdf.url }}" download class="btn light">
          <i class="fa fa-download"></i> Baixar PDF
        </a>
      </div>
      <object data="{{ movimentacao.termo_pdf.url }}#view=FitH" type="application/pdf" class="pdf-frame">
        <embed src="{{ movimentacao.termo_pdf.url }}" type="application/pdf" class="pdf-frame"/>
        <p class="muted" style="padding:8px">
          Seu navegador não consegue exibir PDF embutido.
          <a href="{{ movimentacao.termo_pdf.url }}" target="_blank">Clique aqui para abrir</a>.
        </p>
      </object>
    </div>
    {% endif %}

    <!-- Bloco 5: Auditoria -->
    <div class="section">
      <h3><i class="fa fa-user-shield" style="color:var(--accent-2)"></i> Auditoria</h3>
      <div class="audit">
        <div class="tile">
          <strong>Criado por</strong>
          <span>
            {% if movimentacao and movimentacao.criado_por %}
              {{ movimentacao.criado_por.username|default:"—" }}
            {% else %}—{% endif %}
            ·
            {% if movimentacao and movimentacao.created_at %}
              {{ movimentacao.created_at|date:"d/m/Y H:i" }}
            {% else %}—{% endif %}
          </span>
        </div>
        <div class="tile">
          <strong>Atualizado por</strong>
          <span>
            {% if movimentacao and movimentacao.atualizado_por %}
              {{ movimentacao.atualizado_por.username|default:"—" }}
            {% else %}—{% endif %}
            ·
            {% if movimentacao and movimentacao.updated_at %}
              {{ movimentacao.updated_at|date:"d/m/Y H:i" }}
            {% else %}—{% endif %}
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- Rodapé ações -->
  <div class="footer-actions">
    <a href="{% url 'movimentacao_list' %}" class="btn light"><i class="fa fa-arrow-left"></i> Voltar</a>
    {# <a href="{% url 'movimentacao_update' movimentacao.pk %}" class="btn primary"><i class="fa fa-pen-to-square"></i> Editar</a> #}
  </div>
</div>

<script>
  // Copiar link da página (com fallback simples)
  document.getElementById('btnCopy')?.addEventListener('click', async () => {
    try{
      await navigator.clipboard.writeText(location.href);
      const el = document.getElementById('btnCopy');
      const old = el.innerHTML;
      el.innerHTML = '<i class="fa fa-check"></i> Copiado!';
      setTimeout(()=> el.innerHTML = old, 1600);
    }catch(e){
      alert('Não foi possível copiar o link.');
    }
  });
</script>
{% endblock %}
