{% extends 'base.html' %}
{% load static %}

{% block title %}Detalhe do Usuário{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

<style>
:root{
  --ink:#0f172a; --muted:#475569; --line:#e5e7eb; --soft:#f8fafc; --card:#ffffff;
  --accent:#1e3a8a; --accent-2:#2563eb; --info:#0ea5e9;
  --shadow:0 18px 40px rgba(2,6,23,.08);
  --rad:14px;
}
*{box-sizing:border-box}
a{text-decoration:none}
.page{
  max-width:1100px;margin:16px auto;padding:0 14px;color:var(--ink);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial
}

/* ===== BREADCRUMB ===== */
.breadcrumb{display:flex;gap:8px;align-items:center;flex-wrap:wrap;color:var(--muted);font-weight:700;margin-bottom:10px}
.breadcrumb a{color:var(--muted)}
.breadcrumb a:hover{color:var(--accent-2)}
.badge-id{display:inline-flex;gap:6px;align-items:center;padding:4px 10px;border-radius:999px;background:#eef2ff;border:1px solid #c7d2fe;color:#1e40af;font-weight:900}

/* ===== HEAD ===== */
.head{display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin:4px 0 10px;min-width:0}
.head h1{margin:0;font-size:1.5rem;display:flex;align-items:center;gap:10px}
.chips{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
.chip{
  padding:6px 10px;border-radius:999px;border:1px solid #e2e8f0;background:#fff;
  font-weight:900;font-size:.86rem;display:inline-flex;gap:8px;align-items:center;color:#0f172a;
  max-width:100%;white-space:nowrap;overflow:hidden;text-overflow:ellipsis
}
.chip.status-ativo{background:#e8fff3;border-color:#bbf7d0;color:#166534}
.chip.status-desligado{background:#fee2e2;border-color:#fecaca;color:#7f1d1d}
.chip.pmb-sim{background:#e8fff3;border-color:#bbf7d0;color:#166534}
.chip.pmb-nao{background:#fff7ed;border-color:#fed7aa;color:#7c2d12}

/* ===== SUMMARY STICKY (sem sobreposição) ===== */
.summary{
  position:sticky; top:8px; z-index:10;
  background:rgba(255,255,255,.92); backdrop-filter:saturate(130%) blur(6px);
  border:1px solid var(--line); border-radius:12px; box-shadow:var(--shadow);
  padding:10px; margin-bottom:12px;
  display:grid; grid-template-columns:repeat(12,1fr); gap:10px;
}

/* Cada bloco ocupa 4 colunas (≈ 1/3) no desktop, 6 no tablet, 12 no mobile */
.sum-col{grid-column:span 4; min-width:0; display:flex; gap:10px; align-items:center}
@media (max-width:1024px){ .sum-col{grid-column:span 6} }
@media (max-width:680px){ .sum-col{grid-column:1/-1} }

/* Ações: fica à direita no desktop; vira linha inteira abaixo em telas menores */
.sum-actions{
  grid-column:span 12; display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap
}
@media (min-width:1025px){ .sum-actions{grid-column:10 / -1} }
@media (max-width:1024px){ .sum-actions{grid-column:1 / -1} }

.kv-icon{color:var(--info); flex:0 0 auto}
.kv-text{min-width:0}
.kv-label{color:var(--muted); font-weight:800; line-height:1}
.kv-value{
  font-weight:900; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:100%
}

.btn{
  border:none;border-radius:10px;padding:8px 12px;font-weight:900;cursor:pointer;
  display:inline-flex;align-items:center;gap:8px;white-space:nowrap
}
.btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff}
.btn.light{background:#fff;border:1.3px solid #dbe6f1;color:#334155}
.btn:hover{filter:brightness(.98)}

/* ===== PAINÉIS ===== */
.panel{background:var(--card);border:1px solid var(--line);border-radius:var(--rad);box-shadow:var(--shadow)}
.section{padding:16px 16px 10px}
.section h3{margin:0 0 12px;display:flex;align-items:center;gap:10px;font-size:1.08rem}
.grid{display:grid;gap:12px}
.g-3{grid-template-columns:repeat(3,minmax(240px,1fr))}
.g-2{grid-template-columns:repeat(2,minmax(280px,1fr))}
@media (max-width:900px){.g-3,.g-2{grid-template-columns:1fr}}

.tile{background:#f9fafc;border:1px solid var(--line);border-radius:12px;padding:12px}
.tile strong{display:block;color:#1f2937;margin-bottom:6px}
.tile span{color:var(--ink);word-break:break-word}
.muted{color:var(--muted)}

/* ===== TABELAS ===== */
.table-wrap{width:100%;overflow:auto;border:1px solid var(--line);border-radius:12px;background:#fff}
table{width:100%;border-collapse:collapse;min-width:960px;background:#fff}
thead th{
  position:sticky;top:0;background:linear-gradient(180deg,#18284a 0%, #21439f 100%);
  color:#fff;border-bottom:1px solid #0f172a;padding:10px 12px;text-align:left;font-weight:900
}
tbody td{padding:10px 12px;border-bottom:1px solid #eef2f7;color:#0f172a;vertical-align:top}
tbody tr:nth-child(odd) td{background:#fbfdff}
tbody tr:hover td{background:#f3f7ff}
.status-chip{display:inline-block;padding:3px 10px;border-radius:999px;font-weight:800;font-size:.86rem}
.status-chip.ativo{background:#e8fff3;color:#15803d}
.status-chip.backup{background:#eef2ff;color:#1e40af}
.status-chip.manutencao{background:#fff7ed;color:#9a3412}
.status-chip.defeito{background:#fee2e2;color:#b91c1c}
.icon-btn{background:#fff;border:1.3px solid #dbe3ef;color:#1f2937;border-radius:50%;padding:7px 8px;margin:0 2px;font-size:1.05rem;cursor:pointer;display:inline-flex;align-items:center;justify-content:center}
.icon-btn:hover{background:#f8fbff;border-color:#bcd6ff}

/* ===== FOOTER ===== */
.footer-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}

/* PRINT */
@media print{
  .summary{position:static; top:auto}
  .btn,.footer-actions,.breadcrumb{display:none}
}
</style>

<div class="page">
  <!-- Breadcrumb -->
  <nav class="breadcrumb" aria-label="Navegação">
    <a href="{% url 'usuario_list' %}"><i class="fa fa-arrow-left"></i> Usuários</a>
    <span>/</span>
    <span>Detalhe</span>
    {% if obj and obj.pk %}
      <span class="badge-id"><i class="fa fa-hashtag"></i>{{ obj.pk }}</span>
    {% endif %}
  </nav>

  <!-- Head -->
  <div class="head">
    <h1><i class="fa fa-user"></i> Detalhe do Usuário</h1>
    <div class="chips">
      {% if obj and obj.status %}
        <span class="chip status-{{ obj.status|lower }}">
          <i class="fa fa-circle"></i> {{ obj.get_status_display|default:obj.status|capfirst }}
        </span>
      {% endif %}
      {% if obj and obj.pmb != None %}
        <span class="chip pmb-{{ obj.pmb|lower }}">
          <i class="fa fa-bolt"></i> PMB: {{ obj.get_pmb_display|default:obj.pmb|capfirst }}
        </span>
      {% endif %}
    </div>
  </div>

  <!-- Summary (gruda no topo e não sobrepõe) -->
  <div class="summary" role="region" aria-label="Resumo do usuário">
    <div class="sum-col">
      <i class="fa fa-id-card kv-icon"></i>
      <div class="kv-text">
        <div class="kv-label">Nome</div>
        <div class="kv-value">{{ obj.nome|default:"—" }}</div>
      </div>
    </div>
    <div class="sum-col">
      <i class="fa fa-envelope kv-icon"></i>
      <div class="kv-text">
        <div class="kv-label">E-mail</div>
        <div class="kv-value">{{ obj.email|default:"—" }}</div>
      </div>
    </div>
    <div class="sum-col">
      <i class="fa fa-briefcase kv-icon"></i>
      <div class="kv-text">
        <div class="kv-label">Função</div>
        <div class="kv-value">{% if obj.funcao %}{{ obj.funcao.nome }}{% else %}—{% endif %}</div>
      </div>
    </div>

    <div class="sum-actions">
      <a href="{% url 'usuario_update' obj.pk %}" class="btn light"><i class="fa fa-pen"></i> Editar</a>
      <button class="btn light" type="button" id="btnCopy"><i class="fa fa-link"></i> Copiar link</button>
    
    </div>
  </div>

  <!-- Painel Informações -->
  <div class="panel">
    <div class="section">
      <h3><i class="fa fa-circle-info" style="color:var(--info)"></i> Informações do usuário</h3>
      <div class="grid g-3">
        <div class="tile">
          <strong>Centro de Custo</strong>
          <span>{% if obj.centro_custo %}{{ obj.centro_custo.numero }} — {{ obj.centro_custo.departamento }}{% else %}—{% endif %}</span>
        </div>
        <div class="tile">
          <strong>Localidade</strong>
          <span>{% if obj.localidade %}{{ obj.localidade.local }}{% else %}—{% endif %}</span>
        </div>
        <div class="tile">
          <strong>Data de início</strong>
          <span>{% if obj.data_inicio %}{{ obj.data_inicio|date:"d/m/Y" }}{% else %}—{% endif %}</span>
        </div>
        <div class="tile">
          <strong>Data de término</strong>
          <span>{% if obj.data_termino %}{{ obj.data_termino|date:"d/m/Y" }}{% else %}—{% endif %}</span>
        </div>
        <div class="tile" style="grid-column:1/-1">
          <strong>Auditoria</strong>
          <span class="muted">
            Criado por: {{ obj.criado_por|default:"—" }} ·
            {% if obj.created_at %}{{ obj.created_at|date:"d/m/Y H:i" }}{% else %}—{% endif %}
            &nbsp;&nbsp;|&nbsp;&nbsp;
            Atualizado por: {{ obj.atualizado_por|default:"—" }} ·
            {% if obj.updated_at %}{{ obj.updated_at|date:"d/m/Y H:i" }}{% else %}—{% endif %}
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- Itens -->
  <div class="panel" style="margin-top:12px">
    <div class="section" style="padding-bottom:6px">
      <h3><i class="fa fa-laptop" style="color:var(--accent-2)"></i> Itens atribuídos</h3>
      <div class="muted" style="margin-top:-6px">
        {% with items_do_usuario|length as tot %}
          {{ tot }} item{% if tot != 1 %}s{% endif %}
          · Locação/mês: <strong>R$ {{ totais_itens.loc_mensal|floatformat:2 }}</strong>
          · Aquisição: <strong>R$ {{ totais_itens.aquisicao|floatformat:2 }}</strong>
        {% endwith %}
      </div>
    </div>
    <div class="section" style="padding-top:8px">
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th style="width:56px">#</th>
              <th>Item</th>
              <th>Nº Série</th>
              <th>Subtipo</th>
              <th>Localidade</th>
              <th>Centro de Custo</th>
              <th>Custo</th>
              <th>Status</th>
              <th style="width:120px">Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for it in items_do_usuario %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td style="max-width:260px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">{{ it.nome|default:"—" }}</td>
              <td>{{ it.numero_serie|default:"—" }}</td>
              <td>{% if it.subtipo %}{{ it.subtipo.nome }}{% else %}—{% endif %}</td>
              <td>{% if it.localidade %}{{ it.localidade.local }}{% else %}—{% endif %}</td>
              <td>{% if it.centro_custo %}{{ it.centro_custo.numero }} — {{ it.centro_custo.departamento }}{% else %}—{% endif %}</td>
              <td>
                {% if it.custo_valor %}
                  {% if it.custo_tipo == 'locacao' %}
                    R$ {{ it.custo_valor|floatformat:2 }}/mês
                  {% else %}
                    R$ {{ it.custo_valor|floatformat:2 }}
                  {% endif %}
                {% else %}—{% endif %}
              </td>
              <td><span class="status-chip {{ it.status|lower }}">{{ it.get_status_display|default:it.status|capfirst }}</span></td>
              <td style="white-space:nowrap">
                <a class="icon-btn" title="Detalhar" href="{% url 'equipamento_detalhe' it.id %}"><i class="fa fa-eye"></i></a>
                {% if it.precisa_preventiva == 'sim' %}
                  <a class="icon-btn" title="Iniciar preventiva" style="background:#172133;color:#fff" href="{% url 'preventiva_start_item' it.id %}">
                    <i class="fa fa-shield-heart"></i>
                  </a>
                {% endif %}
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="9" style="text-align:center;color:#64748b;padding:14px">Nenhum item atribuído a este usuário.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Licenças -->
  <div class="panel" style="margin-top:12px">
    <div class="section" style="padding-bottom:6px">
      <h3><i class="fa fa-certificate" style="color:var(--accent)"></i> Licenças atribuídas</h3>
      <div class="muted" style="margin-top:-6px">
        {% with licencas_do_usuario|length as total_lic %}
          {{ total_lic }} licença{% if total_lic != 1 %}s{% endif %}
          · Mensal: <strong>R$ {{ totais_licencas.mensal|floatformat:2 }}</strong>
          · Anual: <strong>R$ {{ totais_licencas.anual|floatformat:2 }}</strong>
        {% endwith %}
      </div>
    </div>
    <div class="section" style="padding-top:8px">
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th style="width:56px">#</th>
              <th>Licença</th>
              <th>Fornecedor</th>
              <th>Periodicidade</th>
              <th>Desde</th>
              <th>Centro de Custo</th>
              <th>PMB</th>
              <th>Custo mensal</th>
              <th>Custo anual</th>
              <th style="width:120px">Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for l in licencas_do_usuario %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td style="max-width:240px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">{{ l.licenca.nome|default:"—" }}</td>
              <td>{% if l.licenca.fornecedor %}{{ l.licenca.fornecedor.nome }}{% else %}—{% endif %}</td>
              <td><span class="chip">{{ l.licenca.get_periodicidade_display|default:l.licenca.periodicidade|capfirst }}</span></td>
              <td>{% if l.desde %}{{ l.desde|date:"d/m/Y H:i" }}{% else %}—{% endif %}</td>
              <td>{% if l.licenca.centro_custo %}{{ l.licenca.centro_custo.numero }} — {{ l.licenca.centro_custo.departamento }}{% else %}—{% endif %}</td>
              <td>{% if l.licenca.pmb != None %}<span class="chip pmb-{{ l.licenca.pmb|lower }}">PMB: {{ l.licenca.get_pmb_display|default:l.licenca.pmb|capfirst }}</span>{% else %}—{% endif %}</td>
              <td>{% if l.custo_mensal %}R$ {{ l.custo_mensal|floatformat:2 }}{% else %}—{% endif %}</td>
              <td>{% if l.custo_anual %}R$ {{ l.custo_anual|floatformat:2 }}{% else %}—{% endif %}</td>
              <td style="white-space:nowrap">
                <a class="icon-btn" title="Detalhar licença" href="{% url 'licenca_detail' l.licenca.id %}"><i class="fa fa-eye"></i></a>
                <a class="icon-btn" title="Movimentar licença" href="{% url 'mov_licenca_form' %}?licenca={{ l.licenca.id }}"><i class="fa fa-exchange-alt"></i></a>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="10" style="text-align:center;color:#64748b;padding:14px">Sem licenças ativas para este usuário.</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Ações finais -->
  <div class="footer-actions">
    <a href="{% url 'usuario_list' %}" class="btn light"><i class="fa fa-arrow-left"></i> Voltar</a>
    <a href="{% url 'usuario_update' obj.pk %}" class="btn primary"><i class="fa fa-pen-to-square"></i> Editar</a>
  </div>
</div>

<script>
  // Copiar link
  document.getElementById('btnCopy')?.addEventListener('click', async () => {
    try{
      await navigator.clipboard.writeText(location.href);
      const el = document.getElementById('btnCopy');
      const old = el.innerHTML;
      el.innerHTML = '<i class="fa fa-check"></i> Copiado!';
      setTimeout(()=> el.innerHTML = old, 1600);
    }catch(e){
      alert('Não foi possível copiar o link.');
    }
  });
</script>
{% endblock %}
