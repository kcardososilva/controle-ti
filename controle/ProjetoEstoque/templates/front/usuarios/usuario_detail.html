{% extends 'base.html' %}
{% load static %}

{% block title %}Detalhe do Usuário{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

<style>
:root{
  /* Paleta neutra corporativa */
  --ink:#0f172a; --muted:#5b6473; --line:#e6e8eb; --soft:#f6f7f8; --card:#ffffff;
  --accent:#1f3a5f; --accent-2:#315b96; --info:#0e7c86;
  --shadow:0 18px 40px rgba(6,14,30,.07);
  --rad:14px;
}
*{box-sizing:border-box}
a{text-decoration:none; color:inherit}
.page{
  max-width:1100px;
  margin:16px auto;
  padding:0 14px 20px;
  color:var(--ink);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial;
}

/* Breadcrumb */
.breadcrumb{display:flex;gap:8px;align-items:center;flex-wrap:wrap;color:var(--muted);font-weight:700;margin-bottom:12px}
.breadcrumb a{color:var(--muted)}
.breadcrumb a:hover{color:var(--accent-2)}
.badge-id{display:inline-flex;gap:6px;align-items:center;padding:4px 10px;border-radius:999px;background:#eef2f6;border:1px solid #d7dee7;color:#2b3b54;font-weight:900}

/* Painel genérico */
.panel{background:var(--card);border:1px solid var(--line);border-radius:var(--rad);box-shadow:var(--shadow);overflow:hidden;margin-top:14px}
.section{padding:16px}
.section h3{margin:0 0 12px;display:flex;align-items:center;gap:10px;font-size:1.08rem}

/* Grid */
.grid{display:grid;gap:12px}
.g-3{grid-template-columns:repeat(3,minmax(240px,1fr))}
@media (max-width:900px){.g-3{grid-template-columns:1fr}}

/* Blocos de informação */
.tile{background:#fbfbfc;border:1px solid var(--line);border-radius:12px;padding:12px}
.tile strong{display:block;color:#1f2937;margin-bottom:6px}
.tile span{color:var(--ink);word-break:break-word}
.muted{color:var(--muted)}

/* Chips */
.chip{
  display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;
  background:#fff;border:1px solid #dfe3e8;color:#1c2738;font-weight:900;font-size:.86rem
}
.chip.status-ativo{background:#eef8f3;border-color:#d6efe1;color:#0d5c42}
.chip.status-desligado{background:#fceeee;border-color:#f6d2d2;color:#7d1a1a}
.chip.pmb-sim{background:#eef8f3;border-color:#d6efe1;color:#0d5c42}
.chip.pmb-nao{background:#fff6eb;border-color:#fde3c3;color:#7f4b10}

/* Tabelas (sem sticky para não colidir com header fixo do app) */
.table-wrap{width:100%;overflow:auto;border:1px solid var(--line);border-radius:12px;background:#fff}
table{width:100%;border-collapse:separate;border-spacing:0;min-width:960px;background:#fff}
thead th{
  background:#f2f4f7;color:#2a3548;border-bottom:1px solid var(--line);
  padding:10px 12px;text-align:left;font-weight:900
}
tbody td{padding:10px 12px;border-bottom:1px solid var(--line);color:#0f172a;vertical-align:top}
tbody tr:nth-child(odd) td{background:#fbfdff}
tbody tr:hover td{background:#f3f7ff}
.status-chip{display:inline-block;padding:3px 10px;border-radius:999px;font-weight:800;font-size:.86rem}
.status-chip.ativo{background:#e8fff3;color:#15803d}
.status-chip.backup{background:#eef2ff;color:#1e40af}
.status-chip.manutencao{background:#fff7ed;color:#9a3412}
.status-chip.defeito,.status-chip.queimado{background:#fee2e2;color:#b91c1c}

.actions-row{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
.icon-btn{background:#fff;border:1.3px solid #dbe3ef;color:#1f2937;border-radius:8px;padding:6px 8px;font-size:.95rem;cursor:pointer;display:inline-flex;align-items:center;gap:6px}
.icon-btn:hover{background:#f8fbff;border-color:#bcd6ff}

/* Rodapé */
.footer-actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
.btn{border:none;border-radius:10px;padding:8px 12px;font-weight:900;cursor:pointer;display:inline-flex;align-items:center;gap:8px;white-space:nowrap}
.btn.light{background:#fff;border:1.3px solid #dbe2ea;color:#2a3548}
.btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff}
</style>

<div class="page">
  <!-- Breadcrumb -->
  <nav class="breadcrumb" aria-label="Navegação">
    <a href="{% url 'usuario_list' %}"><i class="fa fa-arrow-left"></i> Usuários</a>
    <span>/</span> <span>Detalhe</span>
    {% if obj and obj.pk %}<span class="badge-id"><i class="fa fa-hashtag"></i>{{ obj.pk }}</span>{% endif %}
  </nav>

  <!-- Título + Status/PMB -->
  <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;margin:4px 0 10px">
    <h1 style="margin:0;font-size:1.5rem;display:flex;align-items:center;gap:10px"><i class="fa fa-user"></i> Detalhe do Usuário</h1>
    <div style="margin-left:auto;display:flex;gap:8px;flex-wrap:wrap">
      {% if obj and obj.status %}
        <span class="chip status-{{ obj.status|lower }}"><i class="fa fa-circle"></i> {{ obj.get_status_display|default:obj.status|capfirst }}</span>
      {% endif %}
      {% if obj and obj.pmb != None %}
        <span class="chip pmb-{{ obj.pmb|lower }}"><i class="fa fa-bolt"></i> PMB: {{ obj.get_pmb_display|default:obj.pmb|capfirst }}</span>
      {% endif %}
    </div>
  </div>

  <!-- Informações do usuário -->
  <div class="panel">
    <div class="section">
      <h3><i class="fa fa-circle-info" style="color:var(--info)"></i> Informações do usuário</h3>
      <div class="grid g-3">
        <div class="tile">
          <strong>Nome</strong>
          <span>{{ obj.nome|default:"—" }}</span>
        </div>
        <div class="tile">
          <strong>E-mail</strong>
          <span>{% if obj.email %}<a href="mailto:{{ obj.email }}">{{ obj.email }}</a>{% else %}—{% endif %}</span>
        </div>
        <div class="tile">
          <strong>Função</strong>
          <span>{% if obj.funcao %}{{ obj.funcao.nome }}{% else %}—{% endif %}</span>
        </div>
        <div class="tile">
          <strong>Centro de Custo</strong>
          <span>{% if obj.centro_custo %}{{ obj.centro_custo.numero }} — {{ obj.centro_custo.departamento }}{% else %}—{% endif %}</span>
        </div>
        <div class="tile">
          <strong>Localidade</strong>
          <span>{% if obj.localidade %}{{ obj.localidade.local }}{% else %}—{% endif %}</span>
        </div>
        <div class="tile">
          <strong>PMB</strong>
          <span>{% if obj.pmb != None %}{{ obj.get_pmb_display|default:obj.pmb|capfirst }}{% else %}—{% endif %}</span>
        </div>
        <div class="tile">
          <strong>Status</strong>
          <span>{% if obj.status %}{{ obj.get_status_display|default:obj.status|capfirst }}{% else %}—{% endif %}</span>
        </div>
        <div class="tile">
          <strong>Data de início</strong>
          <span>{% if obj.data_inicio %}{{ obj.data_inicio|date:"d/m/Y" }}{% else %}—{% endif %}</span>
        </div>
        <div class="tile">
          <strong>Data de término</strong>
          <span>{% if obj.data_termino %}{{ obj.data_termino|date:"d/m/Y" }}{% else %}—{% endif %}</span>
        </div>
        <div class="tile" style="grid-column:1/-1">
          <strong>Auditoria</strong>
          <span class="muted">
            Criado por: {{ obj.criado_por|default:"—" }} · {% if obj.created_at %}{{ obj.created_at|date:"d/m/Y H:i" }}{% else %}—{% endif %}
            &nbsp;|&nbsp;
            Atualizado por: {{ obj.atualizado_por|default:"—" }} · {% if obj.updated_at %}{{ obj.updated_at|date:"d/m/Y H:i" }}{% else %}—{% endif %}
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- Itens atribuídos -->
  <div class="panel">
    <div class="section" style="padding-bottom:6px">
      <h3><i class="fa fa-laptop" style="color:var(--accent-2)"></i> Itens atribuídos</h3>
      <div class="muted" style="margin-top:-6px">
        {% with items_do_usuario|length as tot %}
          {{ tot }} item{% if tot != 1 %}s{% endif %} · Locação/mês: <strong>R$ {{ totais_itens.loc_mensal|floatformat:2 }}</strong> · Aquisição: <strong>R$ {{ totais_itens.aquisicao|floatformat:2 }}</strong>
        {% endwith %}
      </div>
    </div>
    <div class="section" style="padding-top:8px">
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th style="width:56px">#</th>
              <th>Item</th>
              <th>Nº Série</th>
              <th>Subtipo</th>
              <th>Localidade</th>
              <th>Centro de Custo</th>
              <th>Custo</th>
              <th>Status</th>
              <th style="width:140px">Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for it in items_do_usuario %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td style="max-width:260px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" title="{{ it.nome|default:'—' }}">{{ it.nome|default:"—" }}</td>
              <td>{{ it.numero_serie|default:"—" }}</td>
              <td>{% if it.subtipo %}{{ it.subtipo.nome }}{% else %}—{% endif %}</td>
              <td>{% if it.localidade %}{{ it.localidade.local }}{% else %}—{% endif %}</td>
              <td>{% if it.centro_custo %}{{ it.centro_custo.numero }} — {{ it.centro_custo.departamento }}{% else %}—{% endif %}</td>
              <td>
                {% if it.custo_valor %}
                  {% if it.custo_tipo == 'locacao' %}
                    R$ {{ it.custo_valor|floatformat:2 }}/mês
                  {% else %}
                    R$ {{ it.custo_valor|floatformat:2 }}
                  {% endif %}
                {% else %}—{% endif %}
              </td>
              <td><span class="status-chip {{ it.status|lower }}">{{ it.get_status_display|default:it.status|capfirst }}</span></td>
              <td>
                <div class="actions-row">
                  <a class="icon-btn" title="Detalhar" href="{% url 'equipamento_detalhe' it.id %}"><i class="fa fa-eye"></i> Ver</a>
                  {% if it.precisa_preventiva == 'sim' %}
                    <a class="icon-btn" title="Iniciar preventiva" href="{% url 'preventiva_start_item' it.id %}"><i class="fa fa-shield-heart"></i> Preventiva</a>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% empty %}
            <tr><td colspan="9" style="text-align:center;color:#697385;padding:14px">Nenhum item atribuído a este usuário.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Licenças -->
  <div class="panel">
    <div class="section" style="padding-bottom:6px">
      <h3><i class="fa fa-certificate" style="color:var(--accent)"></i> Licenças atribuídas</h3>
      <div class="muted" style="margin-top:-6px">
        {% with licencas_do_usuario|length as total_lic %}
          {{ total_lic }} licença{% if total_lic != 1 %}s{% endif %} · Mensal: <strong>R$ {{ totais_licencas.mensal|floatformat:2 }}</strong> · Anual: <strong>R$ {{ totais_licencas.anual|floatformat:2 }}</strong>
        {% endwith %}
      </div>
    </div>
    <div class="section" style="padding-top:8px">
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th style="width:56px">#</th>
              <th>Licença</th>
              <th>Fornecedor</th>
              <th>Periodicidade</th>
              <th>Desde</th>
              <th>Centro de Custo</th>
              <th>PMB</th>
              <th>Custo mensal</th>
              <th>Custo anual</th>
              <th style="width:140px">Ações</th>
            </tr>
          </thead>
          <tbody>
            {% for l in licencas_do_usuario %}
            <tr>
              <td>{{ forloop.counter }}</td>
              <td style="max-width:240px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" title="{{ l.licenca.nome|default:'—' }}">{{ l.licenca.nome|default:"—" }}</td>
              <td>{% if l.licenca.fornecedor %}{{ l.licenca.fornecedor.nome }}{% else %}—{% endif %}</td>
              <td><span class="chip">{{ l.licenca.get_periodicidade_display|default:l.licenca.periodicidade|capfirst }}</span></td>
              <td>{% if l.desde %}{{ l.desde|date:"d/m/Y H:i" }}{% else %}—{% endif %}</td>
              <td>{% if l.licenca.centro_custo %}{{ l.licenca.centro_custo.numero }} — {{ l.licenca.centro_custo.departamento }}{% else %}—{% endif %}</td>
              <td>
                {% if l.licenca.pmb != None %}
                  <span class="chip pmb-{{ l.licenca.pmb|lower }}">{{ l.licenca.get_pmb_display|default:l.licenca.pmb|capfirst }}</span>
                {% else %}—{% endif %}
              </td>
              <td>{% if l.custo_mensal %}R$ {{ l.custo_mensal|floatformat:2 }}{% else %}—{% endif %}</td>
              <td>{% if l.custo_anual %}R$ {{ l.custo_anual|floatformat:2 }}{% else %}—{% endif %}</td>
              <td>
                <div class="actions-row">
                  <a class="icon-btn" title="Detalhar licença" href="{% url 'licenca_detail' l.licenca.id %}"><i class="fa fa-eye"></i> Ver</a>
                  <a class="icon-btn" title="Movimentar licença" href="{% url 'mov_licenca_form' %}?licenca={{ l.licenca.id }}"><i class="fa fa-exchange-alt"></i> Mov.</a>
                </div>
              </td>
            </tr>
            {% empty %}
            <tr><td colspan="10" style="text-align:center;color:#697385;padding:14px">Sem licenças ativas para este usuário.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Ações -->
  <div class="footer-actions">
    <a href="{% url 'usuario_list' %}" class="btn light"><i class="fa fa-arrow-left"></i> Voltar</a>
    <a href="{% url 'usuario_update' obj.pk %}" class="btn primary"><i class="fa fa-pen-to-square"></i> Editar</a>
  </div>
</div>
{% endblock %}
