{% extends 'base.html' %}
{% block title %}Controle de Ativos{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<link href="https://fonts.googleapis.com/css?family=Roboto:400,500,700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg:#0e1421; --card:#fff; --ink:#172133; --mut:#5b6b84;
    --line:#e6ecfa; --soft:#f9fafc; --focus:#216eff; --shadow:0 8px 40px rgba(23,33,51,.13);
    --rad:14px; --ctrl-h:46px;
  }
  body{background:linear-gradient(120deg,#181f2a 0%,#253049 100%);font-family:'Roboto',Arial,sans-serif;margin:0;color:var(--ink)}
  *{box-sizing:border-box}

  .wrap{
    max-width: 980px; margin: 34px auto; background: var(--card); border-radius: 22px;
    box-shadow: var(--shadow); border:1px solid #eaf2ff; padding: 34px 34px 26px;
    animation: pop .25s ease;
  }
  @keyframes pop{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}

  .title{display:flex;align-items:center;gap:12px;margin:0 0 18px}
  .title i{color:#1b2740}
  .title h2{margin:0;font-size:1.9rem;color:#172133;letter-spacing:-.5px}

  /* GRID UTIL */
  .grid{display:grid;grid-template-columns:repeat(12,minmax(0,1fr));gap:16px}
  .col-12{grid-column:span 12}
  .col-6{grid-column:span 6}
  .col-4{grid-column:span 4}
  .col-3{grid-column:span 3}
  @media (max-width: 900px){
    .col-md-12{grid-column:span 12}
    .col-md-6{grid-column:span 6}
    .col-md-4{grid-column:span 6}
    .col-md-3{grid-column:span 6}
  }
  @media (max-width: 600px){
    .col-sm-12{grid-column:span 12}
    .col-sm-6{grid-column:span 12}
    .col-sm-4{grid-column:span 12}
    .col-sm-3{grid-column:span 12}
  }

  /* FORM */
  .field{display:flex;flex-direction:column;min-width:0}
  .label{font-weight:700;font-size:.98rem;color:#23304a;margin:2px 0 6px;display:flex;gap:8px;align-items:center}
  .ctrl{
    height:var(--ctrl-h); padding:10px 12px; border:1.2px solid var(--line); border-radius:10px;
    background:var(--soft); color:#1b2640; font-size:1rem; outline:none; box-shadow: inset 0 1px 8px rgba(23,33,51,.06);
  }
  textarea.ctrl{height:auto;min-height:90px;resize:vertical}
  .ctrl:focus{border-color:#216eff; box-shadow:0 0 0 3px rgba(33,110,255,.18), inset 0 1px 8px rgba(23,33,51,.06); background:#fff}
  .hint{font-size:.86rem;color:var(--mut);margin-top:6px}
  .errorlist{list-style:none;margin:6px 0 0;padding:0}
  .errorlist li{background:#fee2e2;color:#b91c1c;border:1px solid #fecaca;padding:8px 10px;border-radius:8px;font-size:.9rem}
  .alert{
    background:#fff6e6;border:1px dashed #ffd085;color:#7a4a00;padding:10px 12px;border-radius:10px;margin-bottom:12px;
    display:flex;gap:8px;align-items:flex-start
  }

  /* SECTION CARD */
  .section{
    background:#f8fbff;border:1px solid #e6efff;border-radius:16px;padding:16px 16px 8px;margin:14px 0;
  }
  .section h4{margin:0 0 8px;color:#1b2740;font-size:1.05rem;display:flex;gap:8px;align-items:center}

  /* BUTTON */
  .actions{display:flex;justify-content:flex-end;margin-top:14px}
  .btn{
    background:linear-gradient(90deg,#243049 0%,#172133 100%); color:#fff; border:none; border-radius:10px;
    height:46px; padding:0 20px; font-weight:800; display:inline-flex; align-items:center; gap:10px; cursor:pointer;
    box-shadow:0 6px 20px rgba(23,33,51,.18); transition:filter .15s, transform .08s;
  }
  .btn:hover{filter:brightness(.96)}
  .btn:active{transform:translateY(1px)}
</style>

<div class="wrap">
  <div class="title">
    <i class="fa {% if editar %}fa-pen-to-square{% else %}fa-plus-circle{% endif %} fa-lg"></i>
    <h2>{% if editar %}Editar Item / Equipamento{% else %}Cadastro de Item / Equipamento{% endif %}</h2>
  </div>

  {% if form.non_field_errors %}
    <div class="alert"><i class="fa fa-triangle-exclamation"></i>
      <div>
        <strong>Revise os dados:</strong>
        <ul class="errorlist">{% for e in form.non_field_errors %}<li>{{ e }}</li>{% endfor %}</ul>
      </div>
    </div>
  {% endif %}

  <form method="post" id="itemForm">
    {% csrf_token %}

    <!-- Principais -->
    <div class="section">
      <h4><i class="fa fa-id-card"></i> Dados principais</h4>
      <div class="grid">
        <div class="field col-6 col-md-6 col-sm-12">
          <label class="label"><i class="fa fa-tag"></i> Nome</label>
          {{ form.nome|default_if_none:"" }}
          {{ form.nome.errors }}
        </div>

        <div class="field col-3 col-md-6 col-sm-12">
          <label class="label"><i class="fa fa-barcode"></i> Nº de Série</label>
          {{ form.numero_serie }}
          {{ form.numero_serie.errors }}
        </div>

        <div class="field col-3 col-md-6 col-sm-12">
          <label class="label"><i class="fa fa-hashtag"></i> Quantidade</label>
          {{ form.quantidade }}
          {{ form.quantidade.errors }}
        </div>
      </div>
    </div>

    <!-- Status / Subtipo / Localidade / Centro de Custo -->
    <div class="section">
      <h4><i class="fa fa-diagram-project"></i> Classificação e Origem</h4>
      <div class="grid">
        <div class="field col-3 col-md-6 col-sm-12">
          <label class="label"><i class="fa fa-circle"></i> Status</label>
          {{ form.status }}
          {{ form.status.errors }}
        </div>

        <div class="field col-3 col-md-6 col-sm-12">
          <label class="label"><i class="fa fa-tags"></i> Subtipo</label>
          {{ form.subtipo }}
          {{ form.subtipo.errors }}
        </div>

        <div class="field col-3 col-md-6 col-sm-12">
          <label class="label"><i class="fa fa-location-dot"></i> Localidade (Origem)</label>
          {{ form.localidade }}
          {{ form.localidade.errors }}
        </div>

        <div class="field col-3 col-md-6 col-sm-12">
          <label class="label"><i class="fa fa-building"></i> Centro de Custo (Origem)</label>
          {{ form.centro_custo }}
          {{ form.centro_custo.errors }}
        </div>
      </div>
    </div>

    <!-- Marca / Modelo -->
    <div class="section">
      <h4><i class="fa fa-microchip"></i> Especificações</h4>
      <div class="grid">
        <div class="field col-6 col-md-6 col-sm-12">
          <label class="label"><i class="fa fa-industry"></i> Marca</label>
          {{ form.marca }}
          {{ form.marca.errors }}
        </div>
        <div class="field col-6 col-md-6 col-sm-12">
          <label class="label"><i class="fa fa-laptop"></i> Modelo</label>
          {{ form.modelo }}
          {{ form.modelo.errors }}
        </div>
      </div>
    </div>

    <!-- PMB / Consumo -->
    <div class="section">
      <h4><i class="fa fa-clipboard-check"></i> Regras de controle</h4>
      <div class="grid">
        <div class="field col-3 col-md-6 col-sm-12">
          <label class="label"><i class="fa fa-shield-halved"></i> PMB?</label>
          {{ form.pmb }}
          {{ form.pmb.errors }}
        </div>
        <div class="field col-3 col-md-6 col-sm-12">
          <label class="label"><i class="fa fa-box-open"></i> É item de consumo?</label>
          {{ form.item_consumo }}
          {{ form.item_consumo.errors }}
        </div>
        <div class="field col-3 col-md-6 col-sm-12">
          <label class="label"><i class="fa fa-dollar-sign"></i> Valor (R$)</label>
          {{ form.valor }}
          {{ form.valor.errors }}
        </div>
        <div class="field col-12 col-sm-12">
          <label class="label"><i class="fa fa-note-sticky"></i> Observações</label>
          {{ form.observacoes }}
          {{ form.observacoes.errors }}
        </div>
      </div>
    </div>

    <!-- Preventiva -->
    <div class="section">
      <h4><i class="fa fa-screwdriver-wrench"></i> Manutenção preventiva</h4>
      <div class="grid">
        <div class="field col-3 col-md-6 col-sm-12">
          <label class="label"><i class="fa fa-circle-question"></i> Precisa de preventiva?</label>
          {{ form.precisa_preventiva }}
          {{ form.precisa_preventiva.errors }}
          <div class="hint">Ao marcar “sim”, informe o intervalo de dias.</div>
        </div>

        <div id="grp_preventiva" class="field col-3 col-md-6 col-sm-12">
          <label class="label"><i class="fa fa-calendar-day"></i> Dias limite preventiva</label>
          {{ form.data_limite_preventiva }}
          {{ form.data_limite_preventiva.errors }}
        </div>
      </div>
    </div>

    <!-- Compra / Locação -->
    <div class="section">
      <h4><i class="fa fa-file-invoice-dollar"></i> Aquisição / Locação</h4>
      <div class="grid">
        <div class="field col-3 col-md-6 col-sm-12">
          <label class="label"><i class="fa fa-circle-question"></i> Equipamento é locado?</label>
          {{ form.locado }}
          {{ form.locado.errors }}
        </div>
      </div>

      <!-- Campos não locado -->
      <div id="box_nao_locado">
        <div class="grid" style="margin-top:8px">
          <div class="field col-3 col-md-6 col-sm-12">
            <label class="label"><i class="fa fa-calendar"></i> Data de compra</label>
            {{ form.data_compra }}
            {{ form.data_compra.errors }}
          </div>
          <div class="field col-3 col-md-6 col-sm-12">
            <label class="label"><i class="fa fa-receipt"></i> Número do pedido</label>
            {{ form.numero_pedido }}
            {{ form.numero_pedido.errors }}
          </div>
        </div>
      </div>

      <!-- Campos locação -->
      <div id="box_locado" style="display:none">
        <div class="grid" style="margin-top:8px">
          <div class="field col-3 col-md-6 col-sm-12">
            <label class="label"><i class="fa fa-clock"></i> Tempo locado (meses)</label>
            {{ locacao_form.tempo_locado }}
            {{ locacao_form.tempo_locado.errors }}
          </div>
          <div class="field col-3 col-md-6 col-sm-12">
            <label class="label"><i class="fa fa-dollar-sign"></i> Valor mensal (R$)</label>
            {{ locacao_form.valor_mensal }}
            {{ locacao_form.valor_mensal.errors }}
          </div>
          <div class="field col-6 col-md-12 col-sm-12">
            <label class="label"><i class="fa fa-file-signature"></i> Contrato</label>
            {{ locacao_form.contrato }}
            {{ locacao_form.contrato.errors }}
          </div>
          <div class="field col-6 col-md-12 col-sm-12">
            <label class="label"><i class="fa fa-truck"></i> Fornecedor da locação</label>
            {{ locacao_form.fornecedor }}
            {{ locacao_form.fornecedor.errors }}
          </div>
          <div class="field col-12">
            <label class="label"><i class="fa fa-comment"></i> Observações da locação</label>
            {{ locacao_form.observacoes }}
            {{ locacao_form.observacoes.errors }}
          </div>
        </div>
      </div>
    </div>

    <div class="actions">
      <button class="btn" type="submit"><i class="fa fa-save"></i> {% if editar %}Atualizar{% else %}Salvar{% endif %}</button>
    </div>
  </form>
</div>

<script>
  (function(){
    const $ = (sel,ctx=document)=>ctx.querySelector(sel);
    const $$ = (sel,ctx=document)=>Array.from(ctx.querySelectorAll(sel));

    // Mapeia controles (Django gera ids padrão "id_<nome>")
    const selLocado = $('#id_locado');
    const boxLocado = $('#box_locado');
    const boxNaoLocado = $('#box_nao_locado');

    const selPrev = $('#id_precisa_preventiva');
    const grpPrev = $('#grp_preventiva');

    // Funções
    function toggleLocacao(){
      const isLoc = (selLocado?.value||'').toLowerCase() === 'sim';
      boxLocado.style.display = isLoc ? '' : 'none';
      boxNaoLocado.style.display = isLoc ? 'none' : '';
      // habilita / desabilita inputs internos para não enviar dados indevidos
      $$('.field input, .field select, .field textarea', boxLocado).forEach(el=> el.disabled = !isLoc);
      $$('.field input, .field select, .field textarea', boxNaoLocado).forEach(el=> el.disabled = isLoc);
    }

    function togglePreventiva(){
      const need = (selPrev?.value||'').toLowerCase() === 'sim';
      grpPrev.style.display = need ? '' : 'none';
      $$('input, select, textarea', grpPrev).forEach(el => el.disabled = !need);
    }

    // Inicializa com valores atuais (útil em edição)
    if(selLocado){ selLocado.addEventListener('change', toggleLocacao); toggleLocacao(); }
    if(selPrev){ selPrev.addEventListener('change', togglePreventiva); togglePreventiva(); }

    // Aplica classes de estilo base aos widgets (caso o form não tenha widgets custom)
    $$('.wrap select, .wrap input, .wrap textarea').forEach(el => el.classList.add('ctrl'));
  })();
</script>
{% endblock %}
