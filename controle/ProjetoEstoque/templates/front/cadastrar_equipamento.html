{% extends 'base.html' %}
{% block title %}{{ editar|yesno:"Editar Item,Cadastro de Item" }}{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<link rel="dns-prefetch" href="https://cdn.jsdelivr.net">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">

<style>
:root{
  --bg:#0e1421; --card:#ffffff; --ink:#0f172a; --mut:#64748b; --line:#e5e7eb; --soft:#f8fafc;
  --p1:#1e3a8a; --p2:#2563eb; --ok:#10b981; --warn:#f59e0b; --bad:#ef4444;
  --focus:#2563eb; --shadow:0 18px 40px rgba(2,6,23,.08);
  --rad:14px; --ctrl-h:46px;
}
body{background:linear-gradient(120deg,#181f2a 0%,#253049 100%);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
*{box-sizing:border-box}

.page{max-width:1040px;margin:18px auto;padding:0 14px}
.wrap{background:var(--card);border:1px solid var(--line);border-radius:22px;box-shadow:var(--shadow);padding:24px 22px 18px;animation:pop .22s ease}
@keyframes pop{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}

.head{display:flex;align-items:center;gap:12px;margin-bottom:12px;flex-wrap:wrap}
.head .icon{background:linear-gradient(135deg,var(--p1),var(--p2));color:#fff;border-radius:12px;display:inline-flex;align-items:center;justify-content:center;width:42px;height:42px;box-shadow:0 8px 18px rgba(37,99,235,.25)}
.head h2{margin:0;font-weight:900;letter-spacing:.2px;font-size:1.35rem;color:var(--ink)}
.badge{margin-left:auto;background:#eef4ff;border:1px solid #dbe8ff;color:#1e3a8a;border-radius:999px;font-weight:800;padding:6px 10px}

.alert{background:#fff6e6;border:1px dashed #ffd085;color:#7a4a00;padding:10px 12px;border-radius:10px;margin:8px 0 14px;display:flex;gap:8px}
.errorlist{list-style:none;margin:6px 0 0;padding:0}
.errorlist li{background:#fee2e2;color:#b91c1c;border:1px solid #fecaca;padding:8px 10px;border-radius:8px;font-size:.92rem}

/* grid util */
.grid{display:grid;grid-template-columns:repeat(12,minmax(0,1fr));gap:14px}
.col-12{grid-column:span 12}.col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-3{grid-column:span 3}
@media (max-width:980px){.col-md-12{grid-column:span 12}.col-md-6{grid-column:span 6}.col-md-4{grid-column:span 6}.col-md-3{grid-column:span 6}}
@media (max-width:640px){.col-sm-12{grid-column:span 12}.col-sm-6{grid-column:span 12}.col-sm-4{grid-column:span 12}.col-sm-3{grid-column:span 12}}

/* section card */
.section{background:#ffffff;border:1px solid var(--line);border-radius:16px;padding:14px 14px 8px}
.section h4{margin:0 0 10px;display:flex;align-items:center;gap:8px;color:#0f172a}
.section + .section{margin-top:12px}

/* field */
.field{display:flex;flex-direction:column;min-width:0}
.label{font-weight:800;font-size:.95rem;color:#0f172a;margin:0 0 6px;display:flex;gap:8px;align-items:center}
.ctrl{height:var(--ctrl-h);padding:10px 12px;border:1.2px solid var(--line);border-radius:10px;background:var(--soft);color:#0f172a;font-size:1rem;outline:none}
textarea.ctrl{height:auto;min-height:88px}
.ctrl:focus{border-color:#93c5fd;box-shadow:0 0 0 3px #93c5fd33;background:#fff}
.hint{font-size:.86rem;color:var(--mut);margin-top:6px}

/* actions */
.actions{display:flex;justify-content:flex-end;gap:8px;margin-top:16px}
.btn{border:none;border-radius:10px;height:46px;padding:0 18px;font-weight:900;display:inline-flex;align-items:center;gap:10px;cursor:pointer}
.btn-primary{background:linear-gradient(90deg,var(--p1),var(--p2));color:#fff;box-shadow:0 10px 24px rgba(37,99,235,.25)}
.btn-light{background:#fff;border:1.5px solid #dbe6f1;color:#334155}

/* Choices.js tune (busca em selects grandes) */
.choices{font-size:.98rem}
.choices__inner{min-height:var(--ctrl-h);border-radius:10px;border-color:#dbe6f1;background:var(--soft)}
.is-focused .choices__inner{border-color:#93c5fd;box-shadow:0 0 0 3px #93c5fd33}
.choices__list--dropdown{border-color:#dbe6f1;max-height:280px;overflow:auto}
.choices__item--selectable{line-height:1.25}
</style>

<div class="page">
  <div class="wrap">
    <div class="head">
      <div class="icon"><i class="fa {% if editar %}fa-pen-to-square{% else %}fa-plus{% endif %}"></i></div>
      <h2>{% if editar %}Editar Item / Equipamento{% else %}Cadastro de Item / Equipamento{% endif %}</h2>
      
    </div>

    {% if form.non_field_errors %}
      <div class="alert"><i class="fa fa-triangle-exclamation"></i>
        <div>
          <strong>Revise os dados:</strong>
          <ul class="errorlist">{% for e in form.non_field_errors %}<li>{{ e }}</li>{% endfor %}</ul>
        </div>
      </div>
    {% endif %}

    <form method="post" id="itemForm" novalidate>
      {% csrf_token %}

      <!-- PRINCIPAIS -->
      <div class="section" aria-labelledby="sec-principais">
        <h4 id="sec-principais"><i class="fa fa-id-card"></i> Dados principais</h4>
        <div class="grid">
          <div class="field col-6 col-md-6 col-sm-12">
            <label class="label" for="{{ form.nome.id_for_label }}"><i class="fa fa-tag"></i> Nome</label>
            {{ form.nome }}
            {{ form.nome.errors }}
          </div>

          <div class="field col-3 col-md-6 col-sm-12">
            <label class="label" for="{{ form.numero_serie.id_for_label }}"><i class="fa fa-barcode"></i> Nº de Série</label>
            {{ form.numero_serie }}
            {{ form.numero_serie.errors }}
          </div>

          <div class="field col-3 col-md-6 col-sm-12">
            <label class="label" for="{{ form.quantidade.id_for_label }}"><i class="fa fa-hashtag"></i> Quantidade</label>
            {{ form.quantidade }}
            {{ form.quantidade.errors }}
          </div>
        </div>
      </div>

      <!-- CLASSIFICAÇÃO -->
      <div class="section" aria-labelledby="sec-class">
        <h4 id="sec-class"><i class="fa fa-diagram-project"></i> Classificação e Origem</h4>
        <div class="grid">
          <div class="field col-3 col-md-6 col-sm-12">
            <label class="label" for="{{ form.status.id_for_label }}"><i class="fa fa-circle"></i> Status</label>
            {{ form.status }}
            {{ form.status.errors }}
          </div>

          <div class="field col-3 col-md-6 col-sm-12">
            <label class="label" for="{{ form.subtipo.id_for_label }}"><i class="fa fa-tags"></i> Subtipo</label>
            {{ form.subtipo }}
            {{ form.subtipo.errors }}
          </div>

          <div class="field col-3 col-md-6 col-sm-12">
            <label class="label" for="{{ form.localidade.id_for_label }}"><i class="fa fa-location-dot"></i> Localidade (Origem)</label>
            {{ form.localidade }}
            {{ form.localidade.errors }}
          </div>

          <div class="field col-3 col-md-6 col-sm-12">
            <label class="label" for="{{ form.centro_custo.id_for_label }}"><i class="fa fa-building"></i> Centro de Custo (Origem)</label>
            {{ form.centro_custo }}
            {{ form.centro_custo.errors }}
          </div>
        </div>
      </div>

      <!-- ESPECIFICAÇÕES -->
      <div class="section" aria-labelledby="sec-espec">
        <h4 id="sec-espec"><i class="fa fa-microchip"></i> Especificações</h4>
        <div class="grid">
          <div class="field col-6 col-md-6 col-sm-12">
            <label class="label" for="{{ form.marca.id_for_label }}"><i class="fa fa-industry"></i> Marca</label>
            {{ form.marca }}
            {{ form.marca.errors }}
          </div>
          <div class="field col-6 col-md-6 col-sm-12">
            <label class="label" for="{{ form.modelo.id_for_label }}"><i class="fa fa-laptop"></i> Modelo</label>
            {{ form.modelo }}
            {{ form.modelo.errors }}
          </div>
        </div>
      </div>

      <!-- REGRAS -->
      <div class="section" aria-labelledby="sec-regras">
        <h4 id="sec-regras"><i class="fa fa-clipboard-check"></i> Regras de Controle</h4>
        <div class="grid">
          <div class="field col-3 col-md-6 col-sm-12">
            <label class="label" for="{{ form.pmb.id_for_label }}"><i class="fa fa-shield-halved"></i> PMB?</label>
            {{ form.pmb }}
            {{ form.pmb.errors }}
          </div>
          <div class="field col-3 col-md-6 col-sm-12">
            <label class="label" for="{{ form.item_consumo.id_for_label }}"><i class="fa fa-box-open"></i> É item de consumo?</label>
            {{ form.item_consumo }}
            {{ form.item_consumo.errors }}
          </div>
          <div class="field col-3 col-md-6 col-sm-12">
            <label class="label" for="{{ form.valor.id_for_label }}"><i class="fa fa-dollar-sign"></i> Valor (R$)</label>
            {{ form.valor }}
            {{ form.valor.errors }}
          </div>
          <div class="field col-12">
            <label class="label" for="{{ form.observacoes.id_for_label }}"><i class="fa fa-note-sticky"></i> Observações</label>
            {{ form.observacoes }}
            {{ form.observacoes.errors }}
          </div>
        </div>
      </div>

      <!-- PREVENTIVA -->
      <div class="section" aria-labelledby="sec-prev">
        <h4 id="sec-prev"><i class="fa fa-screwdriver-wrench"></i> Manutenção Preventiva</h4>
        <div class="grid">
          <div class="field col-3 col-md-6 col-sm-12">
            <label class="label" for="{{ form.precisa_preventiva.id_for_label }}"><i class="fa fa-circle-question"></i> Precisa de preventiva?</label>
            {{ form.precisa_preventiva }}
            {{ form.precisa_preventiva.errors }}
            <div class="hint">Ao marcar “sim”, preencha a **data limite**.</div>
          </div>
          <div id="grp_preventiva" class="field col-3 col-md-6 col-sm-12">
            <label class="label" for="{{ form.data_limite_preventiva.id_for_label }}"><i class="fa fa-calendar-day"></i> Data limite preventiva</label>
            {{ form.data_limite_preventiva }}
            {{ form.data_limite_preventiva.errors }}
          </div>
        </div>
      </div>

      <!-- AQUISIÇÃO / LOCAÇÃO -->
      <div class="section" aria-labelledby="sec-aq">
        <h4 id="sec-aq"><i class="fa fa-file-invoice-dollar"></i> Aquisição / Locação</h4>
        <div class="grid">
          <div class="field col-3 col-md-6 col-sm-12">
            <label class="label" for="{{ form.locado.id_for_label }}"><i class="fa fa-circle-question"></i> Equipamento é locado?</label>
            {{ form.locado }}
            {{ form.locado.errors }}
          </div>
        </div>

        <div id="box_nao_locado">
          <div class="grid" style="margin-top:8px">
            <div class="field col-3 col-md-6 col-sm-12">
              <label class="label" for="{{ form.data_compra.id_for_label }}"><i class="fa fa-calendar"></i> Data de compra</label>
              {{ form.data_compra }}
              {{ form.data_compra.errors }}
            </div>
            <div class="field col-3 col-md-6 col-sm-12">
              <label class="label" for="{{ form.numero_pedido.id_for_label }}"><i class="fa fa-receipt"></i> Número do pedido</label>
              {{ form.numero_pedido }}
              {{ form.numero_pedido.errors }}
            </div>
          </div>
        </div>

        <div id="box_locado" style="display:none">
          <div class="grid" style="margin-top:8px">
            <div class="field col-3 col-md-6 col-sm-12">
              <label class="label" for="{{ locacao_form.tempo_locado.id_for_label }}"><i class="fa fa-clock"></i> Tempo locado (meses)</label>
              {{ locacao_form.tempo_locado }}
              {{ locacao_form.tempo_locado.errors }}
            </div>
            <div class="field col-3 col-md-6 col-sm-12">
              <label class="label" for="{{ locacao_form.valor_mensal.id_for_label }}"><i class="fa fa-dollar-sign"></i> Valor mensal (R$)</label>
              {{ locacao_form.valor_mensal }}
              {{ locacao_form.valor_mensal.errors }}
            </div>
            <div class="field col-6 col-md-12 col-sm-12">
              <label class="label" for="{{ locacao_form.contrato.id_for_label }}"><i class="fa fa-file-signature"></i> Contrato</label>
              {{ locacao_form.contrato }}
              {{ locacao_form.contrato.errors }}
            </div>
            <div class="field col-6 col-md-12 col-sm-12">
              <label class="label" for="{{ locacao_form.fornecedor.id_for_label }}"><i class="fa fa-truck"></i> Fornecedor (locação)</label>
              {{ locacao_form.fornecedor }}
              {{ locacao_form.fornecedor.errors }}
            </div>
            <div class="field col-12">
              <label class="label" for="{{ locacao_form.observacoes.id_for_label }}"><i class="fa fa-comment"></i> Observações da locação</label>
              {{ locacao_form.observacoes }}
              {{ locacao_form.observacoes.errors }}
            </div>
          </div>
        </div>
      </div>

      <div class="actions">
        <a href="javascript:history.back()" class="btn btn-light"><i class="fa fa-arrow-left"></i> Voltar</a>
        <button class="btn btn-primary" type="submit"><i class="fa fa-save"></i> {% if editar %}Atualizar{% else %}Salvar{% endif %}</button>
      </div>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
<script>
(function(){
  const $ = (s,ctx=document)=>ctx.querySelector(s);
  const $$ = (s,ctx=document)=>Array.from(ctx.querySelectorAll(s));

  // Aplica classe visual padrão aos inputs simples (caso widget não aplique)
  $$('.wrap input:not([type=checkbox]):not([type=radio]), .wrap textarea').forEach(e=>e.classList.add('ctrl'));
  // Selects: adiciona classe base antes do enhancement
  $$('.wrap select').forEach(e=>e.classList.add('ctrl'));

  // Melhorias de SELECT com busca (Choices.js)
  // Seletores grandes típicos: subtipo, localidade, centro_custo, fornecedor, status, etc.
  const selectIds = [
    '{{ form.subtipo.auto_id }}',
    '{{ form.localidade.auto_id }}',
    '{{ form.centro_custo.auto_id }}',
    '{{ form.status.auto_id }}',
    '{{ form.pmb.auto_id }}',
    '{{ form.item_consumo.auto_id }}',
    '{{ form.precisa_preventiva.auto_id }}',
    '{{ form.locado.auto_id }}',
    '{{ locacao_form.fornecedor.auto_id|default_if_none:"" }}'
  ].filter(Boolean);

  selectIds.forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    // Não usar multiple => mantém post exatamente como select nativo
    new Choices(el, {
      searchEnabled: true,
      searchPlaceholderValue: 'Pesquisar…',
      shouldSort: false,           // mantém a ordem do Django
      itemSelectText: '',          // sem texto “Press to select”
      duplicateItemsAllowed: false,
      removeItemButton: false,
      placeholder: !!el.getAttribute('placeholder'),
      allowHTML: false,
      position: 'auto',
    });
  });

  // Toggle Locação x Compra
  const selLocado = document.getElementById('{{ form.locado.auto_id }}');
  const boxLocado = document.getElementById('box_locado');
  const boxNaoLocado = document.getElementById('box_nao_locado');
  function isYes(v){ return String(v||'').toLowerCase() === 'sim' || String(v||'1') === '1' || String(v||'true') === 'true' }

  function toggleLocacao(){
    const val = selLocado ? (selLocado.value) : '';
    const show = isYes(val);
    if(boxLocado) boxLocado.style.display = show ? '' : 'none';
    if(boxNaoLocado) boxNaoLocado.style.display = show ? 'none' : '';
    if(boxLocado){ boxLocado.querySelectorAll('input,select,textarea').forEach(i=>i.disabled = !show); }
    if(boxNaoLocado){ boxNaoLocado.querySelectorAll('input,select,textarea').forEach(i=>i.disabled = show); }
  }
  if(selLocado){ selLocado.addEventListener('change', toggleLocacao); toggleLocacao(); }

  // Toggle Preventiva
  const selPrev = document.getElementById('{{ form.precisa_preventiva.auto_id }}');
  const grpPrev = document.getElementById('grp_preventiva');
  function togglePreventiva(){
    const val = selPrev ? selPrev.value : '';
    const show = isYes(val);
    if(grpPrev){ grpPrev.style.display = show ? '' : 'none'; grpPrev.querySelectorAll('input,select,textarea').forEach(i=>i.disabled = !show); }
  }
  if(selPrev){ selPrev.addEventListener('change', togglePreventiva); togglePreventiva(); }
})();
</script>
{% endblock %}
