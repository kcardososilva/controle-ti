{% extends 'base.html' %}
{% load static %}
{% block title %}Controle de Ativos{% endblock %}

{% block content %}
<style>
:root{
  /* Neutros profissionais + acentos sóbrios */
  --ink:#0f172a; --muted:#475569; --line:#e5e7eb; --soft:#f8fafc; --card:#ffffff;
  --accent:#1e3a8a; --accent-2:#2563eb;
  --ok:#16a34a; --warn:#d97706; --bad:#ef4444; --info:#0ea5e9;
  --shadow:0 16px 36px rgba(2,6,23,.07);
  --ctrl-h:38px; --rad:10px; --pad-icon:34px;
}
*{box-sizing:border-box}
a{text-decoration:none}
.page{
  max-width:1200px;margin:16px auto;padding:0 14px;color:var(--ink);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial
}

/* ===== KPI CARDS (compactos, neutros + acento sutil) ===== */
.cards-grid{
  display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));
  gap:10px;margin:6px 0 12px
}
.kpi{
  --tone:#94a3b8;
  background:linear-gradient(180deg,#ffffff 0%,#f9fafb 100%);
  border:1px solid var(--line);
  border-radius:12px;
  padding:10px 12px;
  box-shadow:var(--shadow);
  min-width:0;position:relative;overflow:hidden;isolation:isolate;
  transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease;
}
.kpi:hover{ transform:translateY(-1px); border-color:#d6e2f3; box-shadow:0 14px 28px rgba(2,6,23,.08); }
.kpi::before{
  content:"";position:absolute;left:0;top:0;bottom:0;width:4px;border-radius:12px 0 0 12px;background:linear-gradient(180deg,var(--tone),color-mix(in srgb,var(--tone) 40%,#ffffff))
}
.kpi .kpi-row{display:flex;align-items:center;gap:10px}
.kpi .kpi-icon{
  width:28px;height:28px;border-radius:10px;
  background:color-mix(in srgb,var(--tone) 18%, #e2e8f0);
  display:inline-flex;align-items:center;justify-content:center;
  color:color-mix(in srgb,var(--tone) 88%, #0f172a);
  font-size:.9rem;flex:0 0 28px
}
.kpi .kpi-title{font-size:.82rem;font-weight:800;color:#0f172a;margin:0;letter-spacing:.2px}
.kpi .kpi-value{font-size:1.22rem;font-weight:900;letter-spacing:.2px;color:#0b1220;margin-top:2px}
.kpi .kpi-desc{font-size:.72rem;color:#64748b;letter-spacing:.3px;text-transform:uppercase;margin-top:1px}
.kpi[data-variant="ativos"]      { --tone:#22c55e; }
.kpi[data-variant="backup"]      { --tone:#3b82f6; }
.kpi[data-variant="manutencao"]  { --tone:#f59e0b; }
.kpi[data-variant="defeitos"]    { --tone:#ef4444; }
.kpi[data-variant="total"]       { --tone:#7c3aed; }

/* ===== SHELL ===== */
.shell{
  background:#fff;border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow);
  padding:10px 12px 14px
}

/* Topbar */
.list-top{display:flex;align-items:center;gap:10px;padding:6px 4px 10px;flex-wrap:wrap}
.list-top h3{margin:0;font-size:1.05rem;color:#0f172a;display:flex;align-items:center;gap:8px}
.count-muted{color:#64748b;font-weight:700}
.top-actions{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
.btn{border:none;border-radius:9px;padding:8px 12px;font-weight:800;cursor:pointer;display:inline-flex;align-items:center;gap:8px}
.btn-add{background:linear-gradient(90deg,#10b981,#059669);color:#fff}
.btn-export{background:linear-gradient(90deg,#1e3a8a,#2563eb);color:#fff}
.btn:hover{filter:brightness(.97)}

/* ===== FILTER BAR (compacta) ===== */
.filters{border:1px solid var(--line);border-radius:12px;background:#fff}
.filters summary{list-style:none;cursor:pointer;display:flex;align-items:center;gap:10px;padding:10px 12px;font-weight:800;color:#0f172a}
.filters summary::-webkit-details-marker{display:none}
.filters summary .hint{font-weight:600;color:#64748b;font-size:.9rem}
.filters[open] summary{border-bottom:1px solid var(--line)}
.filters-body{padding:10px 12px}
.filters-grid{display:grid;gap:10px;align-items:end;grid-template-columns:repeat(12,1fr)}
.fld{min-width:0}
.fld label{display:none} /* placeholders comunicam */
.filtro-icon-input{position:relative}
.filtro-icon-input i{position:absolute;left:10px;top:50%;transform:translateY(-50%);color:#334155;pointer-events:none;font-size:.95rem}
.filtro-icon-input input,.filtro-icon-input select{
  width:100%;height:var(--ctrl-h);padding:6px 12px 6px var(--pad-icon);
  border:1px solid #d5deea;border-radius:9px;background:var(--soft);color:#111827;font-size:.95rem;outline:none;
  transition:border .15s,box-shadow .15s,background .15s;appearance:none;
}
.filtro-icon-input input::placeholder{color:#64748b}
.filtro-icon-input input:focus,.filtro-icon-input select:focus{border-color:#93c5fd;box-shadow:0 0 0 3px #93c5fd33;background:#fff}
.select-wrapper{position:relative}
.select-wrapper::after{content:"";position:absolute;right:12px;top:50%;transform:translateY(-25%);border-left:5px solid transparent;border-right:5px solid transparent;border-top:6px solid #64748b;pointer-events:none}
.select-wrapper select{padding-right:30px}

/* Alocação desktop */
.fld-nome{grid-column:span 4}
.fld-serie{grid-column:span 3}
.fld-subtipo{grid-column:span 2}
.fld-status{grid-column:span 2}
.fld-actions{grid-column:span 1;display:flex;gap:8px;justify-content:flex-end}
.fld-row-2{grid-column:1/-1;display:grid;grid-template-columns:repeat(12,1fr);gap:10px}
.fld-fornecedor{grid-column:span 4}
.fld-localidade{grid-column:span 4}
.fld-centro{grid-column:span 4}

/* Botões filtro */
.btn-filtrar,.btn-clear{
  height:var(--ctrl-h);border-radius:9px;padding:0 12px;font-weight:800;display:inline-flex;gap:6px;align-items:center;white-space:nowrap;border:1px solid transparent
}
.btn-filtrar{background:linear-gradient(180deg, var(--accent) 0%, var(--accent-2) 100%);color:#fff}
.btn-clear{background:#fff;border:1.3px solid #dbe6f1;color:#334155}
.btn-clear:hover{background:#f8fafc;color:#1e3a8a;border-color:#c9ddff}

/* Responsivo filtros */
@media (max-width:1100px){
  .fld-nome{grid-column:span 6}
  .fld-serie{grid-column:span 6}
  .fld-subtipo{grid-column:span 4}
  .fld-status{grid-column:span 4}
  .fld-actions{grid-column:span 4}
  .fld-fornecedor,.fld-localidade,.fld-centro{grid-column:span 4}
}
@media (max-width:720px){
  .filters summary{padding:12px}
  .filters-body{padding:10px}
  .filters-grid{grid-template-columns:repeat(6,1fr)}
  .fld-nome{grid-column:1/-1}
  .fld-serie{grid-column:1/-1}
  .fld-subtipo{grid-column:span 3}
  .fld-status{grid-column:span 3}
  .fld-actions{grid-column:1/-1;justify-content:stretch}
  .fld-actions .btn-filtrar{flex:1}
  .fld-actions .btn-clear{flex:0 0 auto}
  .fld-row-2{grid-template-columns:repeat(6,1fr)}
  .fld-fornecedor,.fld-localidade,.fld-centro{grid-column:1/-1}
}

/* Chips rápidos */
.quick-chips{display:flex;gap:8px;flex-wrap:wrap;margin:10px 2px 0}
.quick-chips a{padding:6px 10px;border-radius:999px;border:1px solid #e2e8f0;background:#f8fafc;font-weight:700;color:#0f172a;font-size:.88rem}
.quick-chips a.active{background:#e8f0ff;border-color:#c7d2fe;color:#1e3a8a}

/* ===== TABELA ===== */
.table-wrap{width:100%;overflow:auto;border:1px solid var(--line);border-radius:12px;margin-top:12px;background:#fff}
table{width:100%;border-collapse:collapse;min-width:860px;background:#fff}
thead th{
  position:sticky;top:0;background:#0f172a;
  color:#fff;border-bottom:1px solid #0f172a;
  padding:10px 12px;text-align:left;font-weight:900;user-select:none;cursor:pointer;z-index:2;font-size:.95rem
}
thead th .sort{opacity:.7;font-size:.8rem;margin-left:6px}
tbody td{padding:10px 12px;border-bottom:1px solid #eef2f7;color:#0f172a;font-size:.95rem;background:#fff}
tbody tr:nth-child(odd) td{background:#fbfdff}
tbody tr:hover td{background:#f3f7ff}
tbody tr.clickable{cursor:pointer}
tbody tr.clickable td:last-child{cursor:default}

/* primeira coluna sticky */
td.sticky, th.sticky{position:sticky;left:0;z-index:1;background:inherit;color:#0b1220}
th.sticky{z-index:3}

/* ações */
.td-acoes{text-align:center;white-space:nowrap}
.icon-btn{background:#fff;border:1.3px solid #dbe3ef;color:#1f2937;border-radius:50%;padding:7px 8px;margin:0 2px;font-size:1.05rem;cursor:pointer;display:inline-flex;align-items:center;justify-content:center}
.icon-btn:hover{background:#f8fbff;border-color:#bcd6ff}
.icon-btn.delete{color:#ef4444}

/* status chips */
.status{display:inline-block;padding:3px 10px;border-radius:999px;font-weight:800;font-size:.86rem}
.status.ativo,.status.Ativo{background:#e8fff3;color:#15803d}
.status.backup,.status.Backup{background:#eef2ff;color:#1e40af}
.status.manutencao,.status.Manutencao{background:#fff7ed;color:#9a3412}
.status.defeito,.status.Defeito{background:#fee2e2;color:#b91c1c}

/* ===== MODAL ===== */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:9999}
.modal-content{background:#fff;border-radius:14px;padding:20px 22px;max-width:480px;width:92%;box-shadow:0 10px 30px #0005}
.modal-content h2{margin:0 0 8px;color:#b91c1c;font-size:1.1rem}
.modal-content p{margin:0 0 16px;color:#111827}
.modal-actions{display:flex;gap:10px;justify-content:center}
.btn-danger{background:#ef4444;color:#fff;border-radius:10px;padding:10px 16px;border:none}
.btn-light{background:#f3f4f6;color:#111827;border-radius:10px;padding:10px 16px;border:none}

/* ===== PAGINAÇÃO ===== */
.pagination-wrap{
  display:flex;align-items:center;gap:10px;justify-content:space-between;flex-wrap:wrap;
  margin-top:12px;padding-top:10px;border-top:1px solid var(--line)
}
.page-size{display:flex;align-items:center;gap:8px;color:#475569;font-weight:700}
.page-size select{
  height:32px;border:1px solid #d5deea;border-radius:8px;background:#fff;padding:4px 10px;font-weight:700;color:#0f172a
}
.pager{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.pager a, .pager span{
  padding:6px 10px;border-radius:8px;border:1px solid #e2e8f0;background:#fff;color:#0f172a;font-weight:800;font-size:.9rem;text-decoration:none
}
.pager a:hover{background:#f8fafc}
.pager .current{background:#e8f0ff;border-color:#c7d2fe;color:#1e3a8a}
.pager .disabled{opacity:.5;pointer-events:none}
.range-hint{color:#64748b;font-weight:700}
</style>

<div class="page">
  <!-- KPI CARDS -->
  <div id="kpisWrap" class="cards-grid">
    {% include "front/equipamentos/_kpis.html" %}
  </div>

  <div class="shell">
    <div class="list-top">
      <h3>
        <i class="fa fa-boxes-stacked" style="color:var(--info)"></i>
        Itens cadastrados
        <span class="count-muted">· <span id="countResults">{{ filtered_total }}</span> resultados</span>
      </h3>

      <div class="top-actions">
        <form method="get" id="sizeForm" style="display:flex;align-items:center;gap:8px">
          {% for key, val in request.GET.items %}
            {% if key != 'pp' and key != 'page' %}
              <input type="hidden" name="{{ key }}" value="{{ val }}">
            {% endif %}
          {% endfor %}
          <label for="pp" class="page-size" style="gap:6px;">
            Por página:
            <select name="pp" id="pp">
              <option value="10"  {% if per_page == 10  %}selected{% endif %}>10</option>
              <option value="20"  {% if per_page == 20  %}selected{% endif %}>20</option>
              <option value="50"  {% if per_page == 50  %}selected{% endif %}>50</option>
              <option value="100" {% if per_page == 100 %}selected{% endif %}>100</option>
            </select>
          </label>
        </form>

        <a class="btn btn-add" href="{% url 'cadastrar_equipamento' %}"><i class="fa fa-plus"></i> Adicionar</a>
        {% with qs=request.GET.urlencode %}
          <a class="btn btn-export" href="{% url 'equipamentos_exportar' %}{% if qs %}?{{ qs }}{% endif %}">
            <i class="fa fa-file-export"></i> Exportar
          </a>
        {% endwith %}
      </div>
    </div>

    <!-- FILTROS -->
    <details class="filters" {% if request.GET %}open{% endif %}>
      <summary>
        <i class="fa fa-filter"></i> Filtros
        <span class="hint">— digite para aplicar automaticamente</span>
      </summary>
      <div class="filters-body">
        <form class="filters-grid" autocomplete="off" method="get" id="filtrosForm">
          <div class="fld fld-nome filtro-icon-input">
            <label for="filtro-nome">Nome</label>
            <i class="fa fa-search" aria-hidden="true"></i>
            <input type="text" name="nome" id="filtro-nome" placeholder="Nome" value="{{ request.GET.nome|default:'' }}" aria-label="Buscar por nome">
          </div>

          <div class="fld fld-serie filtro-icon-input">
            <label for="filtro-num-serie">Nº de Série</label>
            <i class="fa fa-barcode" aria-hidden="true"></i>
            <input type="text" name="numero_serie" id="filtro-num-serie" placeholder="Nº de série" value="{{ request.GET.numero_serie|default:'' }}">
          </div>

          <div class="fld fld-subtipo filtro-icon-input select-wrapper">
            <label for="filtro-subtipo">Subtipo</label>
            <i class="fa fa-tags" aria-hidden="true"></i>
            <select name="subtipo" id="filtro-subtipo" aria-label="Filtrar por subtipo">
              <option value="">Subtipo</option>
              {% for sub in subtipos %}
                <option value="{{ sub.id }}" {% if request.GET.subtipo == sub.id|stringformat:"s" %}selected{% endif %}>{{ sub.nome }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="fld fld-status filtro-icon-input select-wrapper">
            <label for="filtro-status">Status</label>
            <i class="fa fa-circle" aria-hidden="true"></i>
            <select name="status" id="filtro-status" aria-label="Filtrar por status">
              <option value="">Status</option>
              {% for code, label in status_choices %}
                <option value="{{ code }}" {% if request.GET.status == code %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="fld fld-actions">
            <button class="btn-filtrar" type="submit" title="Aplicar filtros (Enter)"><i class="fa fa-filter"></i> Filtrar</button>
            <button class="btn-clear" type="button" id="btnLimpar" title="Limpar filtros (Esc)"><i class="fa fa-eraser"></i> Limpar</button>
          </div>

          <div class="fld-row-2">
            <div class="fld fld-fornecedor filtro-icon-input">
              <label for="filtro-fornecedor">Fornecedor</label>
              <i class="fa fa-truck" aria-hidden="true"></i>
              <input type="text" name="fornecedor" id="filtro-fornecedor" placeholder="Fornecedor" value="{{ request.GET.fornecedor|default:'' }}">
            </div>

            <div class="fld fld-localidade filtro-icon-input">
              <label for="filtro-localidade">Localidade</label>
              <i class="fa fa-location-dot" aria-hidden="true"></i>
              <input type="text" name="localidade" id="filtro-localidade" placeholder="Localidade" value="{{ request.GET.localidade|default:'' }}">
            </div>

            <div class="fld fld-centro filtro-icon-input">
              <label for="filtro-centro-custo">Centro de Custo</label>
              <i class="fa fa-coins" aria-hidden="true"></i>
              <input type="text" name="centro_custo" id="filtro-centro-custo" placeholder="Centro de Custo" value="{{ request.GET.centro_custo|default:'' }}">
            </div>
          </div>
        </form>

        <!-- atalhos rápidos -->
        <div class="quick-chips" aria-label="Atalhos de status" id="chipsWrap">
          {% with s=request.GET.status|default:'' %}
            <a href="?{% if request.GET.nome %}nome={{request.GET.nome}}&{% endif %}{% if request.GET.subtipo %}subtipo={{request.GET.subtipo}}&{% endif %}" class="{% if not s %}active{% endif %}">Todos</a>
            <a href="?status=ativo{% if request.GET.nome %}&nome={{request.GET.nome}}{% endif %}{% if request.GET.subtipo %}&subtipo={{request.GET.subtipo}}{% endif %}" class="{% if s == 'ativo' %}active{% endif %}">Ativo</a>
            <a href="?status=backup{% if request.GET.nome %}&nome={{request.GET.nome}}{% endif %}{% if request.GET.subtipo %}&subtipo={{request.GET.subtipo}}{% endif %}" class="{% if s == 'backup' %}active{% endif %}">Backup</a>
            <a href="?status=manutencao{% if request.GET.nome %}&nome={{request.GET.nome}}{% endif %}{% if request.GET.subtipo %}&subtipo={{request.GET.subtipo}}{% endif %}" class="{% if s == 'manutencao' %}active{% endif %}">Manutenção</a>
            <a href="?status=defeito{% if request.GET.nome %}&nome={{request.GET.nome}}{% endif %}{% if request.GET.subtipo %}&subtipo={{request.GET.subtipo}}{% endif %}" class="{% if s == 'defeito' %}active{% endif %}">Defeito</a>
          {% endwith %}
        </div>
      </div>
    </details>

    <!-- TABELA -->
    <div class="table-wrap">
      <table id="tabelaEquipamentos">
        <thead>
          <tr>
            <th class="sticky" data-col="0" style="left:0"># <span class="sort"></span></th>
            <th data-col="1">Nome <span class="sort"></span></th>
            <th data-col="2">Subtipo <span class="sort"></span></th>
            <th data-col="3">Status <span class="sort"></span></th>
            <th data-col="5">Localidade <span class="sort"></span></th>
            <th data-col="6">Nº Série <span class="sort"></span></th>
            <th data-col="7">Fornecedor <span class="sort"></span></th>
            <th>Ações</th>
          </tr>
        </thead>
        <tbody id="tbodyEquipamentos">
          {% include "front/equipamentos/_tbody.html" %}
        </tbody>
      </table>
    </div>

    <!-- PAGINAÇÃO -->
    <div id="paginationWrap">
      {% include "front/equipamentos/_pagination.html" %}
    </div>
  </div>
</div>

<!-- Modal de exclusão (opcional, sem mudanças) -->
<div id="deleteModal" class="modal-overlay" aria-hidden="true">
  <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
    <h2 id="modalTitle"><i class="fa fa-trash"></i> Excluir Item</h2>
    <p id="deleteMessage"></p>
    <form id="deleteForm" method="post" action="">
      {% csrf_token %}
      <div class="modal-actions">
        <button type="submit" class="btn btn-danger"><i class="fa fa-trash"></i> Confirmar</button>
        <button type="button" class="btn btn-light" onclick="closeDeleteModal()"><i class="fa fa-arrow-left"></i> Cancelar</button>
      </div>
    </form>
  </div>
</div>

<script>
/* === HELPERS === */
function serializeForm(form){
  const fd = new FormData(form);
  const p = new URLSearchParams();
  for (const [k,v] of fd.entries()) if(v !== "") p.append(k,v);
  return p.toString();
}
function debounce(fn, d=350){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), d); } }

/* === LÓGICA DE ATUALIZAÇÃO PARCIAL (Fetch) === */
const filtrosForm = document.getElementById('filtrosForm');
const sizeForm    = document.getElementById('sizeForm');
const tbodyEl     = document.getElementById('tbodyEquipamentos');
const pagWrap     = document.getElementById('paginationWrap');
const kpisWrap    = document.getElementById('kpisWrap');
const countEl     = document.getElementById('countResults');

async function refreshList(extraParams={}){
  const base = new URL(window.location.href);
  // monta query atual (form + extras)
  const qs = new URLSearchParams(serializeForm(filtrosForm));
  // parâmetros herdados (pp, page etc.) — exceto page quando digita
  if (sizeForm) {
    const ppSel = sizeForm.querySelector('#pp');
    if (ppSel && ppSel.value) qs.set('pp', ppSel.value);
  }
  for (const k in extraParams){
    if (extraParams[k] === null){ qs.delete(k); } else { qs.set(k, extraParams[k]); }
  }
  qs.set('partial','1');

  const url = `${base.pathname}?${qs.toString()}`;
  const res = await fetch(url, {headers:{'X-Requested-With':'XMLHttpRequest'}});
  if(!res.ok) return;
  const data = await res.json();

  // injeta fragmentos
  if (data.tbody)      tbodyEl.innerHTML = data.tbody;
  if (data.pagination) pagWrap.innerHTML = data.pagination;
  if (data.kpis)       kpisWrap.innerHTML = data.kpis;
  if (typeof data.count !== 'undefined') countEl.textContent = data.count;

  // atualiza URL (sem recarregar)
  const qsNew = new URLSearchParams(qs); qsNew.delete('partial');
  history.replaceState({}, '', `${base.pathname}?${qsNew.toString()}`);

  // reanexa handlers da tabela/paginação
  bindRowNavigation();
  bindPaginationLinks();
  bindSortHeaders();
}

/* === Autosubmit fluido (digitação) === */
if (filtrosForm){
  const ids = ['filtro-nome','filtro-num-serie','filtro-fornecedor','filtro-localidade','filtro-centro-custo'];
  ids.forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.addEventListener('input', debounce(()=> refreshList({page:1}), 350));
  });
  document.getElementById('filtro-subtipo')?.addEventListener('change', ()=>refreshList({page:1}));
  document.getElementById('filtro-status')?.addEventListener('change',  ()=>refreshList({page:1}));

  // submit normal (Enter) cai no Ajax também
  filtrosForm.addEventListener('submit', (e)=>{ e.preventDefault(); refreshList({page:1}); });
  document.getElementById('btnLimpar')?.addEventListener('click', ()=>{ window.location.href = window.location.pathname; });
}

/* === Tamanho da página === */
document.getElementById('pp')?.addEventListener('change', ()=> refreshList({page:1}));

/* === Chips (links) via Ajax: intercepta para não recarregar === */
document.getElementById('chipsWrap')?.addEventListener('click', (e)=>{
  const a = e.target.closest('a'); if(!a) return;
  e.preventDefault();
  const url = new URL(a.href);
  // mantém subtipo/nome se vierem no link
  const params = Object.fromEntries(url.searchParams.entries());
  // zera campos do form e reatribui
  filtrosForm.reset();
  ['nome','subtipo','status'].forEach(k=>{
    const el = filtrosForm.querySelector(`[name="${k}"]`);
    if(el && params[k]) el.value = params[k];
  });
  refreshList({page:1, status: params['status'] || null});
});

/* === Paginação Ajax === */
function bindPaginationLinks(){
  const nav = document.querySelector('#paginationWrap');
  if(!nav) return;
  nav.querySelectorAll('a[href]').forEach(a=>{
    a.addEventListener('click', (e)=>{
      e.preventDefault();
      const url = new URL(a.href);
      const page = url.searchParams.get('page') || 1;
      refreshList({page});
    });
  });
}

/* === Ordenação client-side (reaplica após atualização) === */
let sortState = {}; // coluna -> asc/desc
function bindSortHeaders(){
  const table   = document.getElementById('tabelaEquipamentos');
  const tbody   = table?.querySelector('tbody');
  const headers = table?.querySelectorAll('thead th[data-col]');
  if(!table || !tbody || !headers) return;

  headers.forEach(th=>{
    const col = +th.dataset.col;
    const sortSpan = th.querySelector('.sort');
    // mantém indicador após refresh
    if (sortState[col]) sortSpan.textContent = sortState[col] === 'asc' ? '▲' : '▼';
    th.onclick = ()=>{
      const asc = !(sortState[col] === 'asc');
      sortState = {[col]: asc ? 'asc':'desc'};
      headers.forEach(h=>{const s=h.querySelector('.sort'); if(s) s.textContent='';});
      sortSpan.textContent = asc ? '▲' : '▼';
      const rows = [...tbody.querySelectorAll('tr')];
      const getTxt = (r)=> (r.children[col]?.innerText || '').trim().toLowerCase();
      const cmp = (a,b)=> {
        const na=parseFloat(a.replace(',','.')), nb=parseFloat(b.replace(',','.'));
        if(!isNaN(na)&&!isNaN(nb)) return asc?na-nb:nb-na;
        return asc?a.localeCompare(b):b.localeCompare(a);
      };
      rows.sort((r1,r2)=>cmp(getTxt(r1), getTxt(r2))).forEach(r=>tbody.appendChild(r));
    };
  });
}

/* === Linhas clicáveis === */
function bindRowNavigation(){
  document.querySelectorAll('#tabelaEquipamentos tbody tr.clickable').forEach(tr=>{
    tr.onclick = (e)=>{
      if(e.target.closest('.icon-btn')) return;
      const href = tr.dataset.href; if(href) window.location.href = href;
    };
  });
}

/* === Modal (inalterado) === */
const modal=document.getElementById('deleteModal');
const msg=document.getElementById('deleteMessage');
const delForm=document.getElementById('deleteForm');
function openDeleteModal(id,nome){
  msg.innerHTML=`Tem certeza que deseja excluir o item <b>${nome}</b>?`;
  delForm.action=`/equipamentos/${id}/excluir/`;
  modal.style.display='flex'; modal.setAttribute('aria-hidden','false');
  delForm.querySelector('button[type="submit"]').focus();
}
function closeDeleteModal(){ if(!modal) return; modal.style.display='none'; modal.setAttribute('aria-hidden','true'); }
modal?.addEventListener('click',e=>{ if(e.target===modal) closeDeleteModal(); });

/* === Inicializa bindings === */
bindPaginationLinks();
bindSortHeaders();
bindRowNavigation();
</script>
{% endblock %}
