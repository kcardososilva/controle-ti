{% extends "base.html" %}
{% block title %}Executar Preventiva{% endblock %}
{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

<style>
:root{
  --ink:#0b1220; --muted:#64748b; --line:#e5e7eb; --soft:#f8fafc; --card:#ffffff;
  --bg:#f4f7fc; --primary:#2563eb; --primary-2:#1d4ed8; --ok:#16a34a; --bad:#b91c1c;
  --shadow:0 20px 40px rgba(2,6,23,.07);
}
body{background:var(--bg);}
.page{max-width:980px;margin:18px auto;padding:0 14px}
h2{color:var(--ink)}

.card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);}

.section{padding:14px 16px;border-bottom:1px solid #eef2f7}
.section:last-child{border-bottom:none}
.q-title{font-weight:900;color:var(--ink);margin-bottom:8px}
.required{color:var(--bad);font-weight:900}

.ctrl{height:44px;border:1px solid #dbe3ef;border-radius:12px;padding:8px 12px}
select.ctrl{min-width:280px}
input.ctrl{min-width:240px}

.radio-wrap{display:flex;gap:12px;flex-wrap:wrap}
.radio-pill{
  display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;
  border:1.6px solid #dbe3ef;background:#fff;cursor:pointer;font-weight:800;color:#1f2937;
  transition:.2s ease;
}
.radio-pill input{display:none}
.radio-pill.active{border-color:#93c5fd;background:#eff6ff;color:#1e3a8a;box-shadow:0 0 0 3px #dbeafe}

.grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(260px,1fr))}
.hint{color:var(--muted);font-size:.92rem}

.actions{display:flex;gap:10px;justify-content:flex-end;padding:12px 16px}
.btn{border:none;border-radius:12px;padding:10px 16px;font-weight:900;cursor:pointer;display:inline-flex;align-items:center;gap:8px}
.btn-primary{background:linear-gradient(90deg,var(--primary),var(--primary-2));color:#fff}
.btn-light{background:#fff;border:1.5px solid #dbe3ef;color:#1f2937}
.err-msg{color:var(--bad);font-weight:800;margin-top:6px}
.preview{display:flex;gap:10px;flex-wrap:wrap;margin-top:6px}
.preview img{height:52px;width:auto;border-radius:10px;border:1px solid #e5e7eb}
</style>

<div class="page">
  <h2 style="display:flex;gap:10px;align-items:center;margin:0 0 12px">
    <i class="fa fa-clipboard-check"></i> Executar Preventiva — {{ preventiva.equipamento.nome }}
  </h2>

  <form method="post" enctype="multipart/form-data" class="card" id="form-prev">
    {% csrf_token %}

    {% for p in perguntas %}
      <div class="section">
        <div class="q-title">
          {{ forloop.counter }}. {{ p.texto_pergunta }}
          {% if p.obrigatorio == "sim" %}<span class="required">*</span>{% endif %}
        </div>

        {% with t=p.tipo_resposta|lower %}
          {% if t == "sim_nao" or t == "booleano" or t == "bool" or t == "sn" %}
            <div class="radio-wrap" data-group="r_{{ p.id }}">
              <label class="radio-pill" for="p{{ p.id }}_sim">
                <input type="radio" name="r_{{ p.id }}" id="p{{ p.id }}_sim" value="sim">
                <i class="fa fa-check-circle"></i> Sim
              </label>
              <label class="radio-pill" for="p{{ p.id }}_nao">
                <input type="radio" name="r_{{ p.id }}" id="p{{ p.id }}_nao" value="nao">
                <i class="fa fa-circle-xmark"></i> Não
              </label>
            </div>

          {% elif t == "numero" or t == "inteiro" or t == "decimal" %}
            <input type="number" step="any" class="ctrl" name="r_{{ p.id }}" placeholder="Informe um número">

          {% elif t == "escolha" or t == "opcao" or t == "choice" %}
            <select class="ctrl" name="r_{{ p.id }}">
              <option value="">— selecione —</option>
              {% for opt in p.opcoes_list %}<option value="{{ opt }}">{{ opt }}</option>{% endfor %}
            </select>

          {% else %}
            <input type="text" class="ctrl" name="r_{{ p.id }}" placeholder="Digite a resposta">
          {% endif %}
        {% endwith %}
        <div class="err-msg" id="err_r_{{ p.id }}" style="display:none"></div>
      </div>
    {% empty %}
      <div class="section" style="color:var(--muted)">Nenhuma pergunta cadastrada para este checklist.</div>
    {% endfor %}

    <div class="section">
      <div class="grid">
        <div>
          <label style="font-weight:800;display:block;margin-bottom:6px">Foto — Antes (opcional)</label>
          <input type="file" name="foto_antes" accept="image/*" class="ctrl" id="foto_antes">
          <div class="preview" id="prev_antes"></div>
        </div>
        <div>
          <label style="font-weight:800;display:block;margin-bottom:6px">Foto — Depois (opcional)</label>
          <input type="file" name="foto_depois" accept="image/*" class="ctrl" id="foto_depois">
          <div class="preview" id="prev_depois"></div>
        </div>
      </div>
      <div style="margin-top:10px">
        <label style="font-weight:800;display:block;margin-bottom:6px">Observação (opcional)</label>
        <textarea name="observacao" rows="3" class="ctrl" style="width:100%"></textarea>
        <div class="hint">As fotos e a observação pertencem apenas a esta execução.</div>
      </div>
    </div>

    <div class="actions">
      <a href="{% url 'preventiva_detail' preventiva.id %}" class="btn btn-light"><i class="fa fa-arrow-left"></i> Cancelar</a>
      <button class="btn btn-primary" type="submit"><i class="fa fa-floppy-disk"></i> Salvar execução</button>
    </div>
  </form>
</div>

<script>
/* ===== Radios com “pill” ativo ===== */
document.querySelectorAll('.radio-wrap').forEach(group => {
  group.addEventListener('change', (e) => {
    if (e.target && e.target.name) {
      const name = e.target.name;
      document.querySelectorAll('[data-group="'+name+'"] .radio-pill').forEach(l => l.classList.remove('active'));
      const lbl = e.target.closest('.radio-pill');
      if (lbl) lbl.classList.add('active');
    }
  });
});

/* ===== Pré-visualização leve de imagem ===== */
function previewImage(input, wrapId){
  const wrap = document.getElementById(wrapId);
  if (!wrap) return;
  wrap.innerHTML = "";
  const f = input.files && input.files[0];
  if (!f) return;
  const url = URL.createObjectURL(f);
  const img = document.createElement('img');
  img.src = url; img.alt = 'preview';
  wrap.appendChild(img);
}
document.getElementById('foto_antes')?.addEventListener('change', e=>previewImage(e.target,'prev_antes'));
document.getElementById('foto_depois')?.addEventListener('change', e=>previewImage(e.target,'prev_depois'));

/* ===== Validação leve (não conflita com backend) ===== */
document.getElementById('form-prev')?.addEventListener('submit', (e) => {
  let ok = true;
  // só mostra mensagens visuais para perguntas obrigatórias não respondidas
  document.querySelectorAll('.section .q-title').forEach(q => {
    const req = q.querySelector('.required');
    if (!req) return;
    const sec = q.parentElement;
    const inputs = sec.querySelectorAll('input[name^="r_"], select[name^="r_"]');
    let hasVal = false;
    inputs.forEach(inp => {
      if ((inp.type === 'radio' && inp.checked) ||
          (inp.tagName === 'SELECT' && inp.value) ||
          (inp.type !== 'radio' && inp.value.trim() !== '')) { hasVal = true; }
    });
    const err = sec.querySelector('.err-msg');
    if (!hasVal){
      ok = false;
      if (err){ err.textContent = 'Campo obrigatório.'; err.style.display='block'; }
      sec.scrollIntoView({behavior:'smooth',block:'center'});
    } else if (err){ err.style.display='none'; }
  });
  if (!ok) e.preventDefault();
});
</script>
{% endblock %}
