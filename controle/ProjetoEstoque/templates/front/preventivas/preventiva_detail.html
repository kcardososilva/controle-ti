{% extends "base.html" %}
{% block title %}Detalhes da Preventiva{% endblock %}
{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

<style>
:root{
  --ink:#0b1220; --muted:#64748b; --line:#e5e7eb; --soft:#f8fafc; --card:#ffffff;
  --bg:#f4f7fc;
  --primary:#2563eb; --primary2:#1d4ed8;
  --ok:#16a34a; --warn:#b45309; --bad:#b91c1c;
  --vio:#7c3aed; --cyan:#0891b2; --rose:#be123c; --amber:#f59e0b;
  --shadow:0 24px 48px rgba(2,6,23,.08);
}
body{background:var(--bg);}
.page{max-width:1100px;margin:22px auto;padding:0 14px}
h2{color:var(--ink);margin:0}

.card{background:var(--card);border:1px solid var(--line);border-radius:16px;box-shadow:var(--shadow);}
.bar{display:flex;justify-content:space-between;gap:12px;align-items:center;flex-wrap:wrap;padding:14px 18px;
  background:linear-gradient(90deg, #eef4ff 0%, #ffffff 40%); border-bottom:1px solid #eef2f7}
.btn{border:none;border-radius:12px;padding:10px 16px;font-weight:900;cursor:pointer;display:inline-flex;align-items:center;gap:8px}
.btn-primary{background:linear-gradient(90deg,var(--primary),var(--primary2));color:#fff}
.btn-light{background:#fff;border:1.5px solid #dbe3ef;color:#1f2937}

.filters{display:flex;gap:12px;align-items:end;flex-wrap:wrap;padding:12px 18px;border-bottom:1px solid #eef2f7}
.ctrl{height:44px;border:1px solid #dbe3ef;border-radius:12px;padding:8px 12px}

.section-title{display:flex;align-items:center;gap:10px;margin:0;color:var(--ink)}

.exec-block{
  position:relative;
  background: #ffffff;
  border:1px solid #eef2f7;
  border-radius:16px;
  padding:16px 16px 14px;
  margin:22px 18px;              /* <<< MAIS ESPAÇO ENTRE EXECUÇÕES */
  box-shadow:0 14px 30px rgba(2,6,23,.06);
}
.exec-block::before{
  content:"";
  position:absolute; left:-1px; top:-1px; bottom:-1px; width:8px;
  border-radius:16px 0 0 16px;
  background: linear-gradient(180deg, var(--primary) 0%, var(--cyan) 100%);
  opacity:.95;
}
.exec-block.alt-2::before{ background: linear-gradient(180deg, var(--vio) 0%, var(--primary) 100%); }
.exec-block.alt-3::before{ background: linear-gradient(180deg, var(--ok) 0%, var(--amber) 100%); }
.exec-block.alt-4::before{ background: linear-gradient(180deg, var(--rose) 0%, var(--warn) 100%); }

.exec-head{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:10px}
.exec-badges{display:flex;gap:8px;flex-wrap:wrap}
.badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;font-weight:900;font-size:.85rem;border:1px solid #e5e7eb}
.badge.date{background:#eef2ff;color:#1e3a8a}
.badge.chk{background:#ecfeff;color:#155e75}
.badge.ok{background:#e8fff3;color:#15803d}
.badge.warn{background:#fff7ed;color:#9a3412}

.grid-img{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));margin-top:10px}
.tile{background:#f8fafc;border:1px solid #e5e7eb;border-radius:12px;padding:12px}
.tile strong{display:block;margin-bottom:8px;color:#334155}
.tile img{width:100%;height:auto;border-radius:10px;border:1px solid #e5e7eb;cursor:zoom-in;transition:transform .15s ease}
.tile img:hover{transform:scale(1.01)}

.table-wrap{margin-top:12px;overflow:auto;border:1px solid #eef2f7;border-radius:12px}
table{width:100%;border-collapse:collapse;min-width:720px;background:#fff}
thead th{position:sticky;top:0;background:#0b1220;color:#fff;padding:10px 12px;text-align:left}
tbody td{padding:10px 12px;border-bottom:1px solid #eef2f7;color:#0b1220}
tbody tr:nth-child(odd){background:#fcfdff}

.note{margin-top:10px;background:#f8fafc;border:1px dashed #dbe3ef;border-radius:10px;padding:10px;color:#334155}

.pill{display:inline-block;padding:3px 10px;border-radius:999px;font-weight:800;font-size:.85rem}
.pill.yes{background:#e8fff3;color:#15803d;border:1px solid #bbf7d0}
.pill.no{background:#fee2e2;color:#b91c1c;border:1px solid #fecaca}
.pill.other{background:#eef2ff;color:#1e40af;border:1px solid #c7d2fe}

.empty{color:var(--muted);padding:18px 18px 22px}

/* Lightbox */
.lightbox{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:9999}
.lightbox img{max-width:92vw;max-height:88vh;border-radius:12px;box-shadow:0 30px 80px rgba(0,0,0,.35)}
.lightbox.open{display:flex}
</style>

<div class="page">
  <div class="card">
    <div class="bar">
      <h2 class="section-title"><i class="fa fa-shield-heart"></i> Detalhes da Preventiva — {{ preventiva.equipamento.nome }}</h2>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <a href="{% url 'preventiva_exec' preventiva.id %}" class="btn btn-primary"><i class="fa fa-play"></i> Executar</a>
        <a href="{% url 'preventiva_list' %}" class="btn btn-light"><i class="fa fa-arrow-left"></i> Voltar</a>
      </div>
    </div>

    <form method="get" class="filters">
      <div>
        <label style="font-weight:800;display:block;margin-bottom:6px; color: #0b1220;">Início</label>
        <input type="date" name="inicio" value="{{ dt_ini|date:'Y-m-d' }}" class="ctrl">
      </div>
      <div>
        <label style="font-weight:800;display:block;margin-bottom:6px; color: #0b1220;">Fim</label>
        <input type="date" name="fim" value="{{ dt_fim|date:'Y-m-d' }}" class="ctrl">
      </div>
      <button class="btn btn-light" type="submit"><i class="fa fa-filter"></i> Filtrar</button>
      <a class="btn btn-light" href="{{ request.path }}"><i class="fa fa-eraser"></i> Limpar</a>
    </form>

    {% if execucoes|length == 0 %}
      <div class="empty">Nenhuma execução registrada no período.</div>
    {% endif %}

    {# ==== BLOCO DE EXECUÇÃO (com mais espaço e cores) ==== #}
    {% for bloco in execucoes %}
      {% with ex=bloco.obj linhas=bloco.linhas %}
        <div class="exec-block {% cycle '' 'alt-2' 'alt-3' 'alt-4' %}">
          <div class="exec-head">
            <h3 class="section-title">
              <i class="fa fa-calendar-check" style="color:#2563eb"></i>
              Execução em {{ ex.data_execucao|date:"d/m/Y" }}
            </h3>
            <div class="exec-badges">
              <span class="badge date"><i class="fa fa-clock"></i> {{ ex.data_execucao|date:"d/m/Y" }}</span>
              <span class="badge chk"><i class="fa fa-list-check"></i> {{ preventiva.checklist_modelo.nome|default:"—" }}</span>
            </div>
          </div>

          {% if ex.observacao %}
            <div class="note"><strong>Observações:</strong> {{ ex.observacao }}</div>
          {% endif %}

          <div class="grid-img">
            <div class="tile">
              <strong>Antes</strong>
              {% if ex.foto_antes %}
                <img src="{{ ex.foto_antes.url }}" data-lb="{{ ex.foto_antes.url }}" alt="Antes">
              {% else %}
                <span class="muted">— sem imagem</span>
              {% endif %}
            </div>
            <div class="tile">
              <strong>Depois</strong>
              {% if ex.foto_depois %}
                <img src="{{ ex.foto_depois.url }}" data-lb="{{ ex.foto_depois.url }}" alt="Depois">
              {% else %}
                <span class="muted">— sem imagem</span>
              {% endif %}
            </div>
          </div>

          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Pergunta</th>
                  <th>Resposta</th>
                  <th>Respondido em</th>
                </tr>
              </thead>
              <tbody>
                {% for l in linhas %}
                  <tr>
                    <td>{{ l.pergunta.texto_pergunta }}</td>
                    <td>
                      {% with val=l.resposta|default:""|lower %}
                        {% if val == "sim" %}
                          <span class="pill yes"><i class="fa fa-check"></i> Sim</span>
                        {% elif val == "nao" or val == "não" %}
                          <span class="pill no"><i class="fa fa-xmark"></i> Não</span>
                        {% elif l.resposta %}
                          <span class="pill other">{{ l.resposta }}</span>
                        {% else %}
                          —
                        {% endif %}
                      {% endwith %}
                    </td>
                    <td>{{ l.respondido_em|date:"d/m/Y H:i"|default:"—" }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      {% endwith %}
    {% endfor %}
  </div>
</div>

<!-- Lightbox básico para imagens -->
<div class="lightbox" id="lb"><img alt="preview"></div>

<script>
(function(){
  // Lightbox
  const lb = document.getElementById('lb');
  const img = lb.querySelector('img');
  document.addEventListener('click', (e) => {
    const t = e.target;
    if (t.matches('img[data-lb]')){
      img.src = t.getAttribute('data-lb');
      lb.classList.add('open');
    } else if (t === lb){
      lb.classList.remove('open');
      img.src = '';
    }
  });
})();
</script>
{% endblock %}
