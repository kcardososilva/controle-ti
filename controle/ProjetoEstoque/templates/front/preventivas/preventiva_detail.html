{% extends "base.html" %}
{% block title %}Detalhes da Preventiva{% endblock %}
{% block content %}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>

<style>
:root{
  /* Paleta neutra e profissional, com acento azul corporativo */
  --bg:#f5f7fb; --surface:#ffffff; --surface-2:#f9fbff;
  --ink:#0b1220; --muted:#64748b; --line:#e5e7eb;
  --accent:#1e3a8a; --accent-2:#2563eb; --info:#0ea5e9;
  --ok:#16a34a; --warn:#d97706; --bad:#ef4444;
  --vio:#7c3aed; --cyan:#0891b2; --rose:#be123c; --amber:#f59e0b;

  --rad:14px; --rad-sm:10px;
  --shadow:0 18px 44px rgba(2,6,23,.08);
  --shadow-sm:0 10px 24px rgba(2,6,23,.06);
  --ctrl-h:38px; --pad-icon:34px;
}

/* ===== LAYOUT ===== */
.page{max-width:1200px;margin:16px auto;padding:0 14px;color:var(--ink);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial}

.header-card{
  background:var(--surface); border:1px solid var(--line); border-radius:var(--rad);
  box-shadow:var(--shadow); padding:10px 12px;
}
.header-top{
  display:flex; align-items:center; gap:10px; flex-wrap:wrap; padding:6px 6px 10px;
  border-bottom:1px solid var(--line);
}
.header-title{display:flex; align-items:center; gap:10px; font-weight:900; color:var(--ink)}
.header-actions{display:flex; gap:8px; margin-left:auto; flex-wrap:wrap}
.btn{border:none;border-radius:10px;padding:8px 12px;font-weight:800;cursor:pointer;display:inline-flex;align-items:center;gap:8px}
.btn-primary{background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#fff}
.btn-light{background:#f8fafc;border:1.3px solid #dbe6f1;color:#334155}
.btn:hover{filter:brightness(.98)}

.badges{display:flex; gap:6px; flex-wrap:wrap; margin-left:6px}
.badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;font-weight:800;font-size:.85rem;border:1px solid #e5e7eb;background:#eef2ff;color:#1e3a8a}
.badge.muted{background:#f1f5f9;color:#0f172a}

/* ===== FILTROS ===== */
.filters{
  display:grid; gap:8px; align-items:end; grid-template-columns:repeat(12,1fr);
  padding:10px 6px 2px;
}
.fld{min-width:0}
.fld label{display:block; font-weight:800; margin:0 0 4px; color:#0b1220; font-size:.92rem}
.ctrl{
  width:100%; height:var(--ctrl-h); border:1px solid #dbe3ef; border-radius:10px; padding:6px 10px;
  background:#f8fafc; color:#111827; font-size:.95rem; outline:none; transition:border .15s,box-shadow .15s,background .15s;
}
.ctrl:focus{border-color:#93c5fd;box-shadow:0 0 0 3px #93c5fd33;background:#fff}
.fld-dtini{grid-column:span 3}
.fld-dtfim{grid-column:span 3}
.fld-actions{grid-column:span 6; display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap}

@media (max-width:900px){
  .filters{grid-template-columns:repeat(6,1fr)}
  .fld-dtini,.fld-dtfim{grid-column:span 3}
  .fld-actions{grid-column:1/-1; justify-content:stretch}
  .fld-actions .btn{flex:1}
}

/* ===== TIMELINE (accordion) ===== */
.timeline{
  margin-top:12px;
  display:flex; gap:12px;
  /* Em telas grandes, divide em 2 colunas: sumário compacto à esquerda e blocos à direita */
}
@media (max-width:1000px){ .timeline{flex-direction:column} }

.summary-panel{
  flex:0 0 300px; max-width:300px;
  background:var(--surface); border:1px solid var(--line); border-radius:var(--rad);
  box-shadow:var(--shadow-sm); padding:12px;
  position:sticky; top:calc(72px + 12px); /* abaixo do header fixo da base */
  height:max-content;
}
@media (max-width:1000px){ .summary-panel{position:static; max-width:100%; flex:auto} }

.sum-title{font-weight:900; margin:0 0 8px}
.sum-row{display:flex; justify-content:space-between; gap:10px; padding:6px 0; border-bottom:1px dashed #e5e7eb; font-size:.94rem}
.sum-row:last-child{border-bottom:none}
.sum-k{color:#475569; font-weight:700}
.sum-v{color:#0b1220; font-weight:800}

.blocks{flex:1; display:flex; flex-direction:column; gap:10px}

/* acordeon */
.exec{
  background:var(--surface); border:1px solid var(--line); border-radius:var(--rad);
  box-shadow:var(--shadow-sm); overflow:hidden;
}
.exec summary{
  list-style:none; cursor:pointer; display:flex; align-items:center; gap:10px; padding:10px 12px;
  background:linear-gradient(180deg, var(--surface-2), #fff 70%); user-select:none; position:relative;
}
.exec summary::-webkit-details-marker{display:none}
.exec[open] summary{border-bottom:1px solid var(--line)}
.exec .meta{display:flex; gap:8px; flex-wrap:wrap; margin-left:auto}
.exec .pill{display:inline-flex; align-items:center; gap:6px; padding:3px 10px; border-radius:999px; font-weight:900; font-size:.82rem; border:1px solid #e5e7eb}
.pill.date{background:#eef2ff;color:#1e3a8a}
.pill.chk{background:#ecfeff;color:#155e75}
.pill.ok{background:#e8fff3;color:#15803d}
.pill.warn{background:#fff7ed;color:#9a3412}
.exec .chev{margin-left:auto; color:#64748b}

.exec-body{padding:12px}

/* grid imagens + observações */
.exec-grid{
  display:grid; gap:10px;
  grid-template-columns:2fr 2fr 3fr; /* antes | depois | observações */
}
@media (max-width:1000px){ .exec-grid{grid-template-columns:1fr 1fr} }
@media (max-width:680px){ .exec-grid{grid-template-columns:1fr} }

.tile{background:#f8fafc; border:1px solid #e5e7eb; border-radius:12px; padding:10px}
.tile strong{display:block; margin-bottom:8px; color:#334155}
.tile .muted{color:#94a3b8; font-style:italic}
.tile img{width:100%; height:auto; border-radius:10px; border:1px solid #e5e7eb; cursor:zoom-in; transition:transform .12s ease}
.tile img:hover{transform:scale(1.01)}

/* tabela de respostas */
.table-wrap{overflow:auto; border:1px solid #eef2f7; border-radius:12px}
table{width:100%; min-width:720px; border-collapse:collapse; background:#fff}
thead th{
  position:sticky; top:0;
  background:linear-gradient(180deg,var(--accent) 0%, var(--accent-2) 100%);
  color:#fff; text-align:left; font-weight:900; padding:10px 12px; font-size:.95rem; z-index:1;
}
tbody td{padding:10px 12px; border-bottom:1px solid #eef2f7; color:#0b1220; font-size:.95rem}
tbody tr:nth-child(odd) td{background:#fbfdff}

/* chips yes/no */
.answer{display:inline-block; padding:4px 12px; border-radius:999px; font-weight:900; font-size:.86rem; border:1px solid transparent}
.answer.yes{background:#e8fff3; color:#15803d; border-color:#bbf7d0}
.answer.no{background:#fee2e2; color:#b91c1c; border-color:#fecaca}
.answer.other{background:#eef2ff; color:#1e40af; border-color:#c7d2fe}

/* vazio */
.empty{color:var(--muted); padding:14px 12px}

/* Lightbox */
.lightbox{position:fixed; inset:0; background:rgba(0,0,0,.75); display:none; align-items:center; justify-content:center; z-index:9999}
.lightbox img{max-width:92vw; max-height:88vh; border-radius:12px; box-shadow:0 30px 80px rgba(0,0,0,.35)}
.lightbox.open{display:flex}

/* Print: enxuto e contínuo */
@media print{
  .header-actions, .filters, .summary-panel{display:none!important}
  .page{max-width:none}
  .exec{page-break-inside:avoid}
}
</style>

<div class="page">
  <!-- ===== Cabeçalho / ações ===== -->
  <section class="header-card">
    <div class="header-top">
      <div class="header-title">
        <i class="fa fa-shield-heart" style="color:var(--info)"></i>
        <span>Preventiva • {{ preventiva.equipamento.nome }}</span>
      </div>

      <div class="badges">
        <span class="badge"><i class="fa fa-wrench"></i> Checklist: {{ preventiva.checklist_modelo.nome|default:"—" }}</span>
        <span class="badge muted"><i class="fa fa-hashtag"></i> ID: {{ preventiva.id }}</span>
      </div>

      <div class="header-actions">
        <a href="{% url 'preventiva_exec' preventiva.id %}" class="btn btn-primary"><i class="fa fa-play"></i> Executar</a>
        <a href="{% url 'preventiva_list' %}" class="btn btn-light"><i class="fa fa-arrow-left"></i> Voltar</a>
      </div>
    </div>

    <form method="get" class="filters" autocomplete="off">
      <div class="fld fld-dtini">
        <label for="ini">Início</label>
        <input class="ctrl" type="date" id="ini" name="inicio" value="{{ dt_ini|date:'Y-m-d' }}">
      </div>
      <div class="fld fld-dtfim">
        <label for="fim">Fim</label>
        <input class="ctrl" type="date" id="fim" name="fim" value="{{ dt_fim|date:'Y-m-d' }}">
      </div>
      <div class="fld fld-actions">
        <button class="btn btn-light" type="submit"><i class="fa fa-filter"></i> Filtrar</button>
        <a class="btn btn-light" href="{{ request.path }}"><i class="fa fa-eraser"></i> Limpar</a>
      </div>
    </form>
  </section>

  <!-- ===== Conteúdo principal ===== -->
  <section class="timeline">
    <!-- Painel-resumo (compacto, sticky em desktop) -->
    <aside class="summary-panel" aria-label="Resumo da Preventiva">
      <h3 class="sum-title"><i class="fa fa-layer-group"></i> Resumo</h3>
      <div class="sum-row"><span class="sum-k">Equipamento</span><span class="sum-v" title="{{ preventiva.equipamento.nome }}">{{ preventiva.equipamento.nome }}</span></div>
      <div class="sum-row"><span class="sum-k">Checklist</span><span class="sum-v">{{ preventiva.checklist_modelo.nome|default:"—" }}</span></div>
      <div class="sum-row"><span class="sum-k">Período</span><span class="sum-v">{{ dt_ini|date:"d/m/Y" }} – {{ dt_fim|date:"d/m/Y" }}</span></div>
      <div class="sum-row"><span class="sum-k">Execuções</span><span class="sum-v">{{ execucoes|length }}</span></div>
    </aside>

    <!-- Blocos da timeline -->
    <div class="blocks">
      {% if execucoes|length == 0 %}
        <div class="exec">
          <div class="empty">Nenhuma execução registrada no período informado.</div>
        </div>
      {% endif %}

      {% for bloco in execucoes %}
        {% with ex=bloco.obj linhas=bloco.linhas %}
        <details class="exec" {% if forloop.first %}open{% endif %}>
          <summary>
            <i class="fa fa-calendar-check" style="color:var(--accent-2)"></i>
            <strong>Execução em {{ ex.data_execucao|date:"d/m/Y" }}</strong>
            <div class="meta">
              <span class="pill date"><i class="fa fa-clock"></i> {{ ex.data_execucao|date:"d/m/Y" }}</span>
              <span class="pill chk"><i class="fa fa-list-check"></i> {{ preventiva.checklist_modelo.nome|default:"—" }}</span>
            </div>
            <i class="fa fa-chevron-down chev" aria-hidden="true"></i>
          </summary>

          <div class="exec-body">
            <div class="exec-grid">
              <div class="tile">
                <strong>Antes</strong>
                {% if ex.foto_antes %}
                  <img src="{{ ex.foto_antes.url }}" alt="Foto antes" data-lb="{{ ex.foto_antes.url }}">
                {% else %}
                  <span class="muted">— sem imagem</span>
                {% endif %}
              </div>

              <div class="tile">
                <strong>Depois</strong>
                {% if ex.foto_depois %}
                  <img src="{{ ex.foto_depois.url }}" alt="Foto depois" data-lb="{{ ex.foto_depois.url }}">
                {% else %}
                  <span class="muted">— sem imagem</span>
                {% endif %}
              </div>

              <div class="tile">
                <strong>Observações</strong>
                {% if ex.observacao %}
                  <div style="white-space:pre-wrap">{{ ex.observacao }}</div>
                {% else %}
                  <span class="muted">— sem observações</span>
                {% endif %}
              </div>
            </div>

            <div class="table-wrap" style="margin-top:10px">
              <table>
                <thead>
                  <tr>
                    <th style="width:48%">Pergunta</th>
                    <th style="width:22%">Resposta</th>
                    <th style="width:30%">Respondido em</th>
                  </tr>
                </thead>
                <tbody>
                  {% for l in linhas %}
                    <tr>
                      <td>{{ l.pergunta.texto_pergunta }}</td>
                      <td>
                        {% with val=l.resposta|default:""|lower %}
                          {% if val == "sim" %}
                            <span class="answer yes"><i class="fa fa-check"></i> Sim</span>
                          {% elif val == "nao" or val == "não" %}
                            <span class="answer no"><i class="fa fa-xmark"></i> Não</span>
                          {% elif l.resposta %}
                            <span class="answer other">{{ l.resposta }}</span>
                          {% else %}
                            —
                          {% endif %}
                        {% endwith %}
                      </td>
                      <td>{{ l.respondido_em|date:"d/m/Y H:i"|default:"—" }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </details>
        {% endwith %}
      {% endfor %}
    </div>
  </section>
</div>

<!-- Lightbox básico -->
<div class="lightbox" id="lb"><img alt="preview"></div>

<script>
(function(){
  // Lightbox simples
  const lb = document.getElementById('lb');
  const img = lb.querySelector('img');
  document.addEventListener('click', (e) => {
    const t = e.target;
    if (t.matches('img[data-lb]')){
      img.src = t.getAttribute('data-lb');
      lb.classList.add('open');
    } else if (t === lb){
      lb.classList.remove('open');
      img.src = '';
    }
  });
})();
</script>
{% endblock %}
